
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Health Assessment - ThyroSight</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>


        /* Health Assessment specific styles */
        .assessment-container {
            min-height: calc(100vh - 80px - 200px);
            background: linear-gradient(135deg,
                rgba(37, 99, 235, 0.05) 0%,
                rgba(16, 185, 129, 0.03) 50%,
                rgba(96, 165, 250, 0.04) 100%);
            padding: 1rem;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .assessment-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="50" cy="50" r="1" fill="rgba(59,130,246,0.02)"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
            opacity: 0.4;
            pointer-events: none;
        }

        .assessment-content {
            max-width: 950px;
            margin: 0 auto;
            padding: 0.25rem 1rem;
            position: relative;
            z-index: 2;
        }

        .assessment-form {
            width: 100%;
        }

        .assessment-header {
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .assessment-title {
            font-size: 2.2rem;
            font-weight: 700;
            color: var(--dark-gray);
            margin-bottom: 0.4rem;
            background: linear-gradient(135deg, var(--primary-blue), var(--light-green));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .hero-underline {
            display: flex;
            justify-content: center;
            margin-bottom: 0.75rem;
            gap: 0;
        }

        .underline-segment {
            height: 4px;
            width: 80px;
            border-radius: 2px;
        }

        .underline-segment.blue {
            background: var(--primary-blue);
        }

        .underline-segment.green {
            background: var(--light-green);
        }

        /* Logo hover effects */
        .logo-section a {
            transition: all 0.3s ease;
        }

        .logo-section a:hover {
            transform: translateY(-1px);
            filter: brightness(1.1);
        }

        .logo-section a:hover .logo-text {
            background: linear-gradient(135deg, var(--primary-blue), var(--light-green));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Logout Modal Styles */
        .logout-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(8px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .logout-modal {
            background: white;
            border-radius: 20px;
            max-width: 450px;
            width: 90%;
            box-shadow: 0 25px 70px rgba(0, 0, 0, 0.15);
            overflow: hidden;
            position: relative;
        }

        .logout-modal::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-blue), var(--light-green));
        }

        .logout-modal-header {
            padding: 2rem 2rem 1.5rem;
            text-align: center;
        }

        .logout-icon {
            width: 60px;
            height: 60px;
            background: radial-gradient(circle, var(--primary-blue), var(--light-green));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
            color: white;
            font-size: 1.5rem;
        }

        .logout-modal-header h2 {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--dark-gray);
            margin-bottom: 0.8rem;
        }

        .logout-modal-header p {
            color: var(--dark-gray);
            opacity: 0.8;
            line-height: 1.5;
            margin: 0;
        }

        .logout-modal-actions {
            padding: 0 2rem 2rem;
            display: flex;
            gap: 1rem;
            justify-content: center;
        }

        .logout-btn {
            padding: 0.8rem 1.5rem;
            border-radius: 12px;
            font-weight: 500;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            min-width: 100px;
        }

        .logout-btn.cancel {
            background: white;
            color: var(--dark-gray);
            border: 1px solid #d1d5db;
        }

        .logout-btn.cancel:hover {
            background: #f9fafb;
            border-color: #9ca3af;
        }

        .logout-btn.confirm {
            background: var(--primary-blue);
            color: white;
        }

        .logout-btn.confirm:hover {
            background: #1d4ed8;
            transform: translateY(-1px);
        }

        .assessment-subtitle {
            font-size: 1.1rem;
            color: var(--dark-gray);
            opacity: 0.8;
        }

        .sections-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0;
            margin-bottom: 1rem;
            max-width: 100%;
            width: 100%;
        }

        .assessment-section {
            background: linear-gradient(145deg,
                rgba(255, 255, 255, 0.95) 0%,
                rgba(248, 250, 252, 0.95) 100%);
            border-radius: 24px;
            padding: 1.25rem 0.5rem;
            text-align: left;
            box-shadow:
                0 20px 60px rgba(0, 0, 0, 0.08),
                0 8px 25px rgba(37, 99, 235, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(20px);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            flex: 0 0 300px;
            max-width: 300px;
            height: 400px;
            display: flex;
            flex-direction: column;
        }

        .assessment-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-blue), var(--light-green));
            border-radius: 24px 24px 0 0;
        }

        .assessment-section:hover {
            transform: translateY(-10px);
            box-shadow: 
                0 30px 80px rgba(0, 0, 0, 0.12),
                0 12px 35px rgba(37, 99, 235, 0.15);
        }

        /* Photo Upload Section Specific Styles */
        #photo-upload-section {
            flex: 0 0 300px;
            max-width: 300px;
            height: 400px;
        }

        #photo-upload-section .photo-upload-container {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        #photo-upload-section .photo-upload-area {
            flex: 1;
            min-height: 250px;
        }

        .section-header {
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
            flex-shrink: 0;
            text-align: left;
        }

        .section-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary-blue), var(--light-green));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0;
            color: var(--white);
            font-size: 1rem;
            box-shadow: 
                0 8px 20px rgba(37, 99, 235, 0.3),
                0 4px 15px rgba(16, 185, 129, 0.2);
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .assessment-section:hover .section-icon {
            transform: scale(1.1);
            box-shadow: 
                0 12px 30px rgba(37, 99, 235, 0.4),
                0 8px 25px rgba(16, 185, 129, 0.3);
        }

        .section-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--dark-gray);
            margin: 0;
        }

        .section-content {
            flex: 1;
            overflow-y: auto;
            padding-right: 0.5rem;
            text-align: left;
        }

        .section-content::-webkit-scrollbar {
            width: 6px;
        }

        .section-content::-webkit-scrollbar-track {
            background: rgba(37, 99, 235, 0.1);
            border-radius: 3px;
        }

        .section-content::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, var(--primary-blue), var(--light-green));
            border-radius: 3px;
        }

        .section-content::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, var(--light-green), var(--primary-blue));
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            font-weight: 600;
            color: var(--dark-gray);
            margin-bottom: 0.4rem;
            font-size: 0.95rem;
            line-height: 1.4;
        }

        .form-input {
            width: 100%;
            padding: 0.6rem 0.8rem;
            border: 2px solid var(--light-gray);
            border-radius: 12px;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            background: var(--white);
            color: var(--dark-gray);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .form-input[readonly] {
            background-color: var(--light-gray);
            color: var(--dark-gray);
            cursor: not-allowed;
            border-color: var(--light-gray);
        }

        /* Photo Upload Styles */
        .photo-upload-container {
            margin-top: 0.5rem;
        }

        .photo-upload-area {
            width: 100%;
            height: 200px;
            border: 2px dashed var(--light-gray);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, rgba(37, 99, 235, 0.02), rgba(16, 185, 129, 0.02));
            position: relative;
            overflow: hidden;
        }

        .photo-upload-area:hover {
            border-color: var(--primary-blue);
            background: linear-gradient(135deg, rgba(37, 99, 235, 0.05), rgba(16, 185, 129, 0.05));
        }

        .upload-placeholder {
            text-align: center;
            color: var(--dark-gray);
            opacity: 0.7;
        }

        .upload-placeholder i {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            color: var(--primary-blue);
        }

        .upload-placeholder p {
            margin: 0.5rem 0;
            font-weight: 500;
            font-size: 1rem;
        }

        .upload-hint {
            font-size: 0.85rem;
            opacity: 0.6;
            color: var(--dark-gray);
        }

        .uploaded-photo {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 10px;
        }

        .upload-actions {
            display: flex;
            gap: 0.75rem;
            margin-top: 0.75rem;
            justify-content: center;
        }

        .upload-btn, .remove-btn {
            padding: 0.6rem 1.2rem;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .upload-btn {
            background: var(--primary-blue);
            color: var(--white);
        }

        .upload-btn:hover {
            background: #1d4ed8;
            transform: translateY(-1px);
        }

        .remove-btn {
            background: #ef4444;
            color: var(--white);
        }

        .remove-btn:hover {
            background: #dc2626;
            transform: translateY(-1px);
        }

        .radio-group {
            display: flex;
            gap: 1rem;
            margin-top: 0.4rem;
            flex-wrap: wrap;
        }

        .radio-option {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            cursor: pointer;
            padding: 0.25rem 0.5rem;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .radio-option:hover {
            background: rgba(37, 99, 235, 0.05);
        }

        .radio-option input[type="radio"] {
            width: 18px;
            height: 18px;
            accent-color: var(--primary-blue);
        }

        .radio-option label {
            color: var(--dark-gray);
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 500;
        }

        .conditional-input {
            margin-top: 0.6rem;
            padding: 0.8rem;
            background: linear-gradient(135deg, 
                rgba(37, 99, 235, 0.08), 
                rgba(16, 185, 129, 0.05));
            border-radius: 12px;
            border: 1px solid rgba(37, 99, 235, 0.15);
            display: none;
            animation: slideDown 0.3s ease;
        }

        .conditional-input.show {
            display: block;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .submit-section {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 0.6rem;
            flex-direction: column;
            gap: 0.5rem;
        }

        .submit-btn {
            background: var(--primary-blue);
            color: var(--white);
            border: 1px solid var(--primary-blue);
            padding: 1rem 1rem;
            border-radius: 15px;
            font-weight: 500;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(37, 99, 235, 0.3);
            min-width: 200px;
        }

        .submit-btn:hover {
            background: var(--white);
            color: var(--primary-blue);
            transform: translateY(-3px);
            box-shadow: 0 12px 35px rgba(37, 99, 235, 0.4);
        }

        .submit-btn:disabled {
            background: var(--light-gray);
            color: var(--dark-gray);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .validation-status {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            padding: 2rem;
            border-radius: 15px;
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.9), rgba(220, 38, 38, 0.8));
            border: 3px solid #dc2626;
            color: white;
            font-size: 1rem;
            font-weight: 500;
            display: none;
            box-shadow: 0 20px 60px rgba(220, 38, 38, 0.5);
            animation: slideDown 0.3s ease-out;
            z-index: 10000;
            backdrop-filter: blur(10px);
        }

        .validation-close {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            color: white;
            font-size: 2rem;
            cursor: pointer;
            opacity: 0.8;
            transition: opacity 0.3s ease;
        }

        .validation-close:hover {
            opacity: 1;
        }

        .validation-status.show {
            display: block;
        }

        .validation-status i {
            margin-right: 0.5rem;
            font-size: 1.1rem;
            animation: bounce 1s ease-in-out infinite;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-5px);
            }
            60% {
                transform: translateY(-3px);
            }
        }

        @keyframes flash-highlight {
            0%, 100% { 
                background: rgba(239, 68, 68, 0.1);
                box-shadow: 0 0 0 1px rgba(220, 38, 38, 0.2);
            }
            50% { 
                background: rgba(239, 68, 68, 0.3);
                box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.6);
            }
        }

        .form-group.incomplete {
            border-left: 4px solid #dc2626;
            background: rgba(239, 68, 68, 0.1);
            border-radius: 8px;
            padding-left: 1rem;
            margin-left: -0.5rem;
            box-shadow: 0 0 0 1px rgba(220, 38, 38, 0.2);
            animation: pulse-incomplete 2s ease-in-out infinite;
        }

        .form-group.incomplete .form-label {
            color: #dc2626;
            font-weight: 600;
        }

        .form-group.incomplete .radio-group {
            border-color: #dc2626;
            background: rgba(239, 68, 68, 0.05);
        }

        .form-group.incomplete .radio-group label {
            color: #dc2626;
        }

        @keyframes pulse-incomplete {
            0%, 100% { 
                box-shadow: 0 0 0 1px rgba(220, 38, 38, 0.2);
            }
            50% { 
                box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.4);
            }
        }

        #photo-upload-section.incomplete {
            border-left: 4px solid #dc2626;
            background: rgba(239, 68, 68, 0.1);
            border-radius: 24px;
            box-shadow: 0 0 0 2px rgba(220, 38, 38, 0.3);
            animation: pulse-incomplete 2s ease-in-out infinite;
        }

        #photo-upload-section.incomplete .section-title {
            color: #dc2626;
            font-weight: 600;
        }

        #photo-upload-section.incomplete .photo-upload-area {
            border-color: #dc2626;
            background: rgba(239, 68, 68, 0.05);
        }

        #photo-upload-section.incomplete .section-icon {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            animation: shake 0.5s ease-in-out;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-2px); }
            75% { transform: translateX(2px); }
        }

        /* Profile Completion Notice */
        .profile-completion-notice {
            background: linear-gradient(135deg, rgba(37, 99, 235, 0.1), rgba(16, 185, 129, 0.1));
            border: 1px solid rgba(37, 99, 235, 0.2);
            border-radius: 10px;
            padding: 0.75rem;
            margin-top: 0.5rem;
            text-align: center;
        }

        .notice-content {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .notice-content i {
            font-size: 1.25rem;
            color: var(--primary-blue);
        }

        .notice-text h4 {
            color: var(--dark-gray);
            margin: 0 0 0.2rem 0;
            font-size: 0.9rem;
        }

        .notice-text p {
            color: var(--dark-gray);
            margin: 0;
            opacity: 0.8;
            line-height: 1.3;
            font-size: 0.85rem;
        }

        .complete-profile-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            background: var(--primary-blue);
            color: var(--white);
            padding: 0.5rem 1rem;
            border-radius: 16px;
            text-decoration: none;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(37, 99, 235, 0.3);
        }

        .complete-profile-btn:hover {
            background: var(--white);
            color: var(--primary-blue);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(37, 99, 235, 0.4);
        }

        /* Notification System */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 10000;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            animation: slideInRight 0.3s ease-out;
            max-width: 400px;
        }
        
        .notification.success {
            background: linear-gradient(135deg, #10b981, #059669);
        }
        
        .notification.error {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }
        
        .notification.info {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
        }
        
        .notification i {
            font-size: 1.1rem;
        }

        .notification-close {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            padding: 0;
            margin-left: auto;
            opacity: 0.8;
            transition: opacity 0.2s ease;
        }

        .notification-close:hover {
            opacity: 1;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }





        @keyframes pulse {
            0%, 100% { 
                transform: scale(1);
                box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            }
            50% { 
                transform: scale(1.05);
                box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
            }
        }

        @media (max-width: 768px) {
            .assessment-container {
                padding: 0.75rem;
            }

            .assessment-content {
                padding: 1.5rem 0.75rem;
            }

            .sections-container {
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }

            .assessment-section {
                height: auto;
                min-height: 350px;
                padding: 1.25rem 1rem;
            }
            
            .assessment-title {
                font-size: 2rem;
            }
            
            .section-title {
                font-size: 1.1rem;
            }
            
            .radio-group {
                flex-direction: column;
                gap: 0.8rem;
            }
            
            .submit-btn {
                width: 100%;
                max-width: 280px;
                padding: 0.8rem 1.5rem;
            }

            .notification {
                right: 6px;
                left: 6px;
                max-width: none;
            }
            
            .form-group {
                margin-bottom: 0.8rem;
            }
            
            .section-header {
                margin-bottom: 0.8rem;
                gap: 0.6rem;
            }
            
            .form-label {
                font-size: 0.9rem;
            }
            
            .form-input {
                padding: 0.5rem 0.7rem;
                font-size: 0.9rem;
            }
            
            .section-icon {
                width: 35px;
                height: 35px;
                font-size: 0.9rem;
            }

            #photo-upload-section {
                max-width: none;
                height: auto;
                min-height: 350px;
            }

            #photo-upload-section .photo-upload-area {
                min-height: 200px;
            }


        }

        /* Result Popup Styles */
        .result-popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 1rem;
        }
        


        .result-popup {
            background: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);
            border-radius: 24px;
            max-width: 800px;
            width: 100%;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 
                0 25px 70px rgba(0, 0, 0, 0.15),
                0 10px 30px rgba(37, 99, 235, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(37, 99, 235, 0.1);
            position: relative;
            margin: auto;
        }

        .result-popup::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #3b82f6, #10b981, #8b5cf6, #f59e0b);
            border-radius: 20px 20px 0 0;
        }

        .result-popup-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 2rem 2rem 1.5rem;
            border-bottom: 1px solid rgba(37, 99, 235, 0.1);
            background: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);
            border-radius: 24px 24px 0 0;
            position: sticky;
            top: 0;
            z-index: 10;
            padding-right: 4rem;
        }

        .result-popup-header h2 {
            margin: 0;
            font-size: 1.75rem;
            font-weight: 700;
            background: linear-gradient(135deg, #1e40af, #059669);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            letter-spacing: -0.025em;
        }

        .result-popup-header h2 i {
            font-size: 1.5rem;
            color: #10b981;
            filter: drop-shadow(0 2px 8px rgba(16, 185, 129, 0.3));
        }

        .close-popup {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(220, 38, 38, 0.1));
            border: 1px solid rgba(239, 68, 68, 0.2);
            color: #ef4444;
            font-size: 1.1rem;
            cursor: pointer;
            padding: 0.75rem;
            border-radius: 50%;
            transition: all 0.3s ease;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.15);
            position: absolute;
            top: 2rem;
            right: 2rem;
            z-index: 20;
        }

        .close-popup:hover {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(220, 38, 38, 0.2));
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.25);
        }

        .result-content {
            padding: 2rem;
            overflow-y: auto;
        }

        .result-section {
            margin-bottom: 1.5rem;
            padding: 1.5rem;
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.95), rgba(248, 250, 252, 0.95));
            border-radius: 16px;
            border: 1px solid rgba(37, 99, 235, 0.08);
            box-shadow: 0 4px 25px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            position: relative;
        }

        .result-section:hover {
            box-shadow: 0 8px 35px rgba(37, 99, 235, 0.08);
            transform: translateY(-2px);
        }

        .result-section:last-child {
            margin-bottom: 0;
        }

        .result-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .result-header i {
            font-size: 1.25rem;
            color: var(--primary-blue);
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, rgba(37, 99, 235, 0.1), rgba(16, 185, 129, 0.1));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 3px 12px rgba(37, 99, 235, 0.15);
        }

        .result-header h3 {
            margin: 0;
            font-size: 1.25rem;
            font-weight: 600;
            color: #1e293b;
            letter-spacing: -0.025em;
        }

        /* Mode Badge */
        .mode-badge {
        display: inline-block;
        padding: 6px 12px;
        border-radius: 8px;
        font-weight: 600;
        margin-top: 8px;
        }
        .mode-badge.hybrid {
        background: #e0f7e9;
        color: #0a7a3e;
        }
        .mode-badge.symptom-only {
        background: #fff6d9;
        color: #a26b00;
        }


        /* Thyroid Condition Result */
        .condition-result {
            text-align: center;
            padding: 0.5rem 0;
        }

        .condition-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem 2rem;
            border-radius: 16px;
            box-shadow: 0 6px 25px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            font-weight: 700;
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 0.75px;
            margin-bottom: 1rem;
            position: relative;
            overflow: hidden;
        }

        .condition-badge::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }

        .condition-badge:hover::before {
            left: 100%;
        }
        
        .condition-badge:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.18);
        }
        
        .condition-badge.normal {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: 2px solid #10b981;
        }
        
        .condition-badge.normal i {
            color: #a7f3d0;
            filter: drop-shadow(0 2px 8px rgba(16, 185, 129, 0.4));
        }
        
        .condition-badge.hypo {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            border: 2px solid #3b82f6;
        }
        
        .condition-badge.hypo i {
            color: #93c5fd;
            filter: drop-shadow(0 2px 8px rgba(59, 130, 246, 0.4));
        }
        
        .condition-badge.hyper {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            border: 2px solid #ef4444;
        }
        
        .condition-badge.hyper i {
            color: #fca5a5;
            filter: drop-shadow(0 2px 8px rgba(239, 68, 68, 0.4));
        }

        .condition-badge i {
            font-size: 1.25rem;
            filter: drop-shadow(0 2px 8px rgba(0, 0, 0, 0.2));
        }

        .condition-description {
            color: #6b7280;
            font-size: 1rem;
            line-height: 1.6;
            margin: 0;
            font-weight: 400;
            max-width: 500px;
            margin: 0 auto;
        }

        /* Confidence Score */
        .confidence-display {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            margin-top: 1rem;
        }

        .confidence-circle {
            position: relative;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: conic-gradient(from 0deg, var(--primary-blue) 0deg, var(--light-green) 360deg);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            box-shadow: 0 4px 15px rgba(37, 99, 235, 0.12);
            transition: transform 0.3s ease;
        }

        .confidence-circle:hover {
            transform: scale(1.05);
        }
        
        .confidence-circle::before {
            content: '';
            position: absolute;
            width: 55px;
            height: 55px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ffffff, #f8fafc);
            box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .confidence-number {
            position: relative;
            z-index: 1;
            font-size: 0.55rem;
            font-weight: 700;
            color: var(--primary-blue);
            text-align: center;
            line-height: 1;
        }
        
        .confidence-circle.normal {
            background: conic-gradient(from 0deg, #10b981 0deg, #059669 360deg);
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.2);
        }
        
        .confidence-circle.hypo {
            background: conic-gradient(from 0deg, #3b82f6 0deg, #1d4ed8 360deg);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.2);
        }
        
        .confidence-circle.hyper {
            background: conic-gradient(from 0deg, #ef4444 0deg, #dc2626 360deg);
            box-shadow: 0 8px 25px rgba(239, 68, 68, 0.2);
        }
        
        .confidence-number {
            position: relative;
            z-index: 2;
            font-size: 0.55rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary-blue), var(--light-green));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            filter: drop-shadow(0 2px 8px rgba(0, 0, 0, 0.1));
            margin-bottom: 0;
            line-height: 1;
        }
        
        .confidence-number.normal {
            background: linear-gradient(135deg, #10b981, #059669);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .confidence-number.hypo {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .confidence-number.hyper {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .confidence-label {
            font-size: 0.5rem;
            color: #6b7280;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            text-align: center;
            line-height: 1;
        }

        .confidence-info {
            flex: 1;
            min-width: 0;
        }

        .confidence-info p {
            margin: 0 0 1rem 0;
            color: #6b7280;
            line-height: 1.5;
            font-size: 0.95rem;
            font-weight: 400;
        }

        .confidence-bar {
            width: 100%;
            height: 10px;
            background: rgba(37, 99, 235, 0.08);
            border-radius: 6px;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.08);
        }

        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-blue), var(--light-green));
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(37, 99, 235, 0.3);
            position: relative;
            overflow: hidden;
        }
        
        .confidence-fill.normal {
            background: linear-gradient(90deg, #10b981, #059669);
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
        }
        
        .confidence-fill.hypo {
            background: linear-gradient(90deg, #3b82f6, #1d4ed8);
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
        }
        
        .confidence-fill.hyper {
            background: linear-gradient(90deg, #ef4444, #dc2626);
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
        }

        /* SHAP Factors */
        .shap-factors {
            margin-top: 1rem;
        }
        
        .factors-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-top: 1rem;
        }
        
        .factors-left, .factors-right {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        
        .factor-heading {
            text-align: center;
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            padding: 0.5rem;
            border-radius: 8px;
        }
        
        .factor-heading.positive {
            color: #10b981;
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.05));
        }
        
        .factor-heading.negative {
            color: #ef4444;
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(239, 68, 68, 0.05));
        }
        
        .shap-empty {
            width: 100%;
            padding: 1.5rem;
            border: 1px dashed rgba(37, 99, 235, 0.3);
            border-radius: 16px;
            background: rgba(59, 130, 246, 0.05);
            text-align: center;
            color: #1e3a8a;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            align-items: center;
            font-size: 0.95rem;
        }

        /* Mobile responsive improvements */
        @media (max-width: 768px) {
            .result-popup {
                max-width: 95%;
                max-height: 90vh;
                border-radius: 20px;
            }

            .result-popup-header {
                padding: 1.5rem 1.5rem 1rem;
            }

            .result-content {
                padding: 1.5rem;
            }

            .result-section {
                padding: 1.25rem;
                margin-bottom: 1.25rem;
            }

            .shap-factors {
                grid-template-columns: 1fr;
                gap: 0.75rem;
            }

            .condition-badge {
                padding: 0.75rem 1.5rem;
                font-size: 0.9rem;
            }

            .confidence-display {
                flex-direction: column;
                align-items: center;
                text-align: center;
            }

            .confidence-circle {
                margin-bottom: 1rem;
            }
        }

        .factor-item {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            padding: 0.75rem;
            border-radius: 10px;
            border: 1px solid rgba(37, 99, 235, 0.1);
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(248, 250, 252, 0.9));
            min-height: 120px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.04);
            position: relative;
            text-align: left;
        }

        .factor-item:hover {
            box-shadow: 0 6px 25px rgba(37, 99, 235, 0.08);
            transform: translateY(-1px);
        }

        .factor-item.positive {
            border-left: 4px solid #10b981;
        }

        .factor-item.negative {
            border-left: 4px solid #ef4444;
        }

        .factor-item.neutral {
            border-left: 4px solid #6b7280;
        }

        .factor-icon {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            flex-shrink: 0;
        }

        .factor-item.positive .factor-icon {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.05));
            color: #10b981;
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.15);
        }

        .factor-item.negative .factor-icon {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(239, 68, 68, 0.05));
            color: #ef4444;
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.15);
        }

        .factor-item.neutral .factor-icon {
            background: linear-gradient(135deg, rgba(107, 114, 128, 0.1), rgba(107, 114, 128, 0.05));
            color: #6b7280;
            box-shadow: 0 2px 8px rgba(107, 114, 128, 0.15);
        }

        .factor-content {
            flex: 1;
            min-width: 0;
            text-align: left;
        }

        .factor-content h4 {
            margin: 0 0 0.5rem 0;
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--dark-gray);
            line-height: 1.2;
            text-align: left;
        }

        .factor-content p {
            margin: 0 0 0.75rem 0;
            color: #6b7280;
            line-height: 1.4;
            font-size: 0.85rem;
            font-weight: 400;
            text-align: left;
        }

        .factor-impact {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border: 1px solid;
        }

        .factor-item.positive .factor-impact {
            color: #10b981;
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.05));
            border-color: #10b981;
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.1);
        }

        .factor-item.negative .factor-impact {
            color: #ef4444;
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(239, 68, 68, 0.05));
            border-color: #ef4444;
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.1);
        }

        .factor-item.neutral .factor-impact {
            color: #6b7280;
            background: linear-gradient(135deg, rgba(107, 114, 128, 0.1), rgba(107, 114, 128, 0.05));
            border-color: #6b7280;
            box-shadow: 0 2px 8px rgba(107, 114, 128, 0.1);
        }

        /* Health Tips */
        .health-tips {
            display: grid;
            gap: 0.75rem;
            margin-top: 0.75rem;
        }

        .tip-item {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            padding: 1rem;
            border-radius: 10px;
            background: linear-gradient(135deg, rgba(37, 99, 235, 0.05), rgba(16, 185, 129, 0.05));
            border: 1px solid rgba(37, 99, 235, 0.1);
            transition: all 0.3s ease;
            box-shadow: 0 2px 12px rgba(37, 99, 235, 0.04);
        }

        .tip-item:hover {
            background: linear-gradient(135deg, rgba(37, 99, 235, 0.08), rgba(16, 185, 129, 0.08));
            box-shadow: 0 6px 25px rgba(37, 99, 235, 0.08);
            transform: translateY(-1px);
        }

        .tip-icon {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--primary-blue), var(--light-green));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            flex-shrink: 0;
            font-size: 1rem;
            box-shadow: 0 3px 12px rgba(37, 99, 235, 0.2);
        }

        .tip-content {
            flex: 1;
            min-width: 0;
        }

        .tip-content h4 {
            margin: 0 0 0.5rem 0;
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--dark-gray);
            line-height: 1.2;
        }

        .tip-content p {
            margin: 0;
            color: #6b7280;
            line-height: 1.4;
            font-size: 0.85rem;
            font-weight: 400;
        }

        /* Result Popup Footer */
        .result-popup-footer {
            display: flex;
            gap: 0.75rem;
            border-top: 1px solid rgba(37, 99, 235, 0.08);
            background: linear-gradient(135deg, rgba(248, 250, 252, 0.95), rgba(255, 255, 255, 0.95));
            border-radius: 0 0 18px 18px;
            justify-content: center;
        }

        .btn-secondary, .btn-primary {
            padding: 0.875rem 2rem;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            border: 1px solid;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.75px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            min-width: 140px;
            justify-content: center;
        }

        .btn-secondary {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(248, 250, 252, 0.95));
            color: #6b7280;
            border-color: rgba(37, 99, 235, 0.15);
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, rgba(37, 99, 235, 0.05), rgba(16, 185, 129, 0.05));
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(37, 99, 235, 0.15);
            border-color: rgba(37, 99, 235, 0.25);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-blue), var(--light-green));
            color: white;
            border-color: transparent;
            box-shadow: 0 4px 20px rgba(37, 99, 235, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(37, 99, 235, 0.4);
        }

        /* Mobile Responsiveness for Result Popup */
        @media (max-width: 768px) {
            .result-popup {
                margin: 0.75rem;
                max-height: 85vh;
                border-radius: 12px;
            }

            .result-popup::before {
                height: 2px;
            }

            .result-popup-header {
                padding: 1rem 1.25rem;
                border-radius: 12px 12px 0 0;
            }

            .result-popup-header h2 {
                font-size: 1.2rem;
            }

            .result-content {
                padding: 1rem;
            }

            .result-section {
                padding: 0.75rem;
                margin-bottom: 1rem;
            }

            .confidence-display {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }

                    .confidence-circle {
            margin-bottom: 0.5rem;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: conic-gradient(from 0deg, var(--primary-blue) 0deg, var(--light-green) 360deg);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 12px;
        }
        
        .confidence-circle::before {
            content: '';
            position: absolute;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ffffff, #f8fafc);
            box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .confidence-circle.normal {
            background: conic-gradient(from 0deg, #10b981 0deg, #059669 360deg);
        }
        
        .confidence-circle.hypo {
            background: conic-gradient(from 0deg, #3b82f6 0deg, #1d4ed8 360deg);
        }
        
        .confidence-circle.hyper {
            background: conic-gradient(from 0deg, #ef4444 0deg, #dc2626 360deg);
        }

            .result-popup-footer {
                flex-direction: column;
                padding: 1rem 1.25rem;
                border-radius: 0 0 12px 12px;
            }

            .btn-secondary, .btn-primary {
                width: 100%;
                justify-content: center;
            }

            .shap-factors {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }
            
            .factor-item {
                min-height: 100px;
                padding: 0.6rem;
            }
            
            .factor-icon {
                width: 28px;
                height: 28px;
                font-size: 0.9rem;
            }
            
            .factor-content h4 {
                font-size: 0.85rem;
            }
            
            .factor-content p {
                font-size: 0.75rem;
            }
            
            .factor-impact {
                font-size: 0.75rem;
                padding: 0.2rem 0.4rem;
            }
        }

        .confidence-info {
            flex: 1;
        }

        /* Enhanced color coding for different conditions */
        .result-section.condition-section {
            border-left: 4px solid;
            transition: all 0.3s ease;
        }
        
        .result-section.condition-section.normal {
            border-left-color: #10b981;
            background: linear-gradient(135deg, #f0fdf4, #ffffff);
        }
        
        .result-section.condition-section.hypo {
            border-left-color: #3b82f6;
            background: linear-gradient(135deg, #eff6ff, #ffffff);
        }
        
        .result-section.condition-section.hyper {
            border-left-color: #ef4444;
            background: linear-gradient(135deg, #fef2f2, #ffffff);
        }
        
        /* Enhanced factor item colors */
        .factor-item.positive {
            border-left-color: #10b981;
            background: linear-gradient(135deg, #f0fdf4, #ffffff);
        }
        
        .factor-item.negative {
            border-left-color: #ef4444;
            background: linear-gradient(135deg, #fef2f2, #ffffff);
        }
        
        .factor-item.neutral {
            border-left-color: #6b7280;
            background: linear-gradient(135deg, #f9fafb, #ffffff);
        }
        
        /* Enhanced impact colors */
        .factor-impact.positive {
            color: #10b981;
            background: linear-gradient(135deg, #d1fae5, #a7f3d0);
        }
        
        .factor-impact.negative {
            color: #ef4444;
            background: linear-gradient(135deg, #fecaca, #fca5a5);
        }
        
        .factor-impact.neutral {
            color: #6b7280;
            background: linear-gradient(135deg, #e5e7eb, #d1d5db);
        }
        
        /* Confidence number and fill color coding */
        .confidence-number {
            position: relative;
            z-index: 2;
            font-size: 0.55rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary-blue), var(--light-green));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
            line-height: 1;
        }
        
        .confidence-number.normal {
            background: linear-gradient(135deg, #10b981, #059669);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .confidence-number.hypo {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .confidence-number.hyper {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-blue), var(--light-green));
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(37, 99, 235, 0.3);
            position: relative;
            overflow: hidden;
        }
        
        .confidence-fill.normal {
            background: linear-gradient(90deg, #10b981, #059669);
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
        }
        
        .confidence-fill.hypo {
            background: linear-gradient(90deg, #3b82f6, #1d4ed8);
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
        }
        
        .confidence-fill.hyper {
            background: linear-gradient(90deg, #ef4444, #dc2626);
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
        }

/* ai insigfht */
        .ai-insights-box {
        background: #f9fafb;
        border-radius: 10px;
        padding: 12px 15px;
        margin-top: 15px;
        font-size: 0.9rem;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .ai-insights-box h4 {
        margin: 0 0 6px;
        color: #333;
        }
        .ai-insights-box ul {
        list-style: none;
        margin: 0;
        padding: 0;
        }
        .ai-insights-box li {
        margin: 4px 0;
        }



        /* SHAP VISUAL*/

        .factors-grid {
  display: flex;
  justify-content: space-between;
  gap: 20px;
  margin-top: 10px;
}

.factors-left, .factors-right {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.factor-heading {
  text-align: center;
  font-size: 1rem;
  font-weight: 600;
  margin-bottom: 5px;
  opacity: 0.8;
}

.factor-heading.positive {
  color: #2ecc71;
}

.factor-heading.negative {
  color: #e74c3c;
}

.factor-item {
  display: flex;
  align-items: flex-start;
  background: #f9f9f9;
  border-radius: 10px;
  padding: 10px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.05);
  transition: transform 0.2s ease;
  text-align: left;
}

.factor-item:hover {
  transform: translateY(-2px);
}

.factor-item.positive {
  border-left: 5px solid #2ecc71;
}

.factor-item.negative {
  border-left: 5px solid #e74c3c;
}

.factor-icon {
  width: 40px;
  text-align: center;
  font-size: 1.3em;
  opacity: 0.8;
}

.factor-content h4 {
  margin: 0;
  font-size: 1em;
  font-weight: 600;
  text-align: left;
}

.factor-content p {
  margin: 0;
  font-size: 0.85em;
  color: #555;
  text-align: left;
}


    </style>
</head>
<body>
    <!-- Creative Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo-section">
                <a href="homepage.html" style="text-decoration: none; color: inherit; display: flex; align-items: center; gap: 0.8rem;">
                    <div class="logo-icon">
                        <img src="thy.png" alt="ThyroSight Logo" class="logo-image">
                    </div>
                    <h1 class="logo-text">ThyroSight</h1>
                </a>
            </div>
            <nav class="nav-links" id="nav-links">
                <a href="dashboard.html" class="nav-link">Dashboard</a>
                <a href="health-assessment.html" class="nav-link">Health Assessment</a>
                <a href="history.html" class="nav-link">History</a>
            </nav>
            <button class="mobile-menu-toggle" id="mobile-menu-toggle">
                <i class="fas fa-bars"></i>
            </button>
            <div class="auth-buttons">
                <a href="auth/logout.php" class="btn btn-outline">Logout</a>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <div class="assessment-container">
            <div class="assessment-content">
                <!-- Header -->
                <div class="assessment-header">
                    <h1 class="assessment-title">Health Assessment</h1>
                    <div class="hero-underline">
                        <div class="underline-segment blue"></div>
                        <div class="underline-segment green"></div>
                    </div>
                            <p class="assessment-subtitle">Complete your thyroid health evaluation</p>
                </div>

                <form id="health-assessment-form" class="assessment-form">
                <div class="sections-container">
                <!-- Basic Info Section -->
                <div class="assessment-section" id="basic-info-section">
                    <div class="section-header">
                        <div class="section-icon">
                            <i class="fas fa-user"></i>
                        </div>
                        <h2 class="section-title">Basic Information</h2>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Date of Birth</label>
                        <input type="text" class="form-input" id="birthdate" readonly>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Age</label>
                        <input type="text" class="form-input" id="calculated-age" readonly>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Gender</label>
                        <input type="text" class="form-input" id="gender-display" readonly>
                    </div>



                    <div class="profile-completion-notice" id="profile-notice" style="display: none;">
                        <div class="notice-content">
                            <i class="fas fa-info-circle"></i>
                            <div class="notice-text">
                                <h4>Profile Incomplete</h4>
                                <p>Your basic information is missing. Please complete your profile to continue with the health assessment.</p>
                            </div>
                        </div>
                        <a href="profile.html" class="complete-profile-btn">
                            <i class="fas fa-user-edit"></i>
                            Complete Profile
                        </a>
                    </div>
                </div>

                <!-- Photo Upload Section -->
                <div class="assessment-section" id="photo-upload-section">
                    <div class="section-header">
                        <div class="section-icon">
                            <i class="fas fa-camera"></i>
                        </div>
                        <h2 class="section-title">Photo Upload</h2>
                    </div>
                    
                    <div class="photo-upload-container">
                        <div class="photo-upload-area" id="photo-upload-area">
                            <div class="upload-placeholder" id="upload-placeholder">
                                <i class="fas fa-camera"></i>
                                <p>Click to upload photo</p>
                                <span class="upload-hint">Face to neck area for thyroid assessment</span>
                            </div>
                            <img id="uploaded-photo" class="uploaded-photo" style="display: none;" alt="Uploaded photo">
                        </div>
                        <input type="file" id="photo-input" accept="image/*" style="display: none;">
                        <div class="upload-actions">
                            <button type="button" class="upload-btn" onclick="document.getElementById('photo-input').click()">
                                <i class="fas fa-upload"></i> Upload Photo
                            </button>
                            <button type="button" class="remove-btn" id="remove-photo" onclick="removePhoto()" style="display: none;">
                                <i class="fas fa-trash"></i> Remove
                            </button>
                        </div>
                    </div>
                </div>

<!-- Medical History  -->
<div class="assessment-section" id="other-medical-history-section">
    <div class="section-header">
        <div class="section-icon">
            <i class="fas fa-notes-medical"></i>
        </div>
        <h2 class="section-title">Medical History</h2>
    </div>

    <div class="section-content">
        <div class="form-group">
            <label class="form-label">Do you have Diabetes?</label>
            <div class="radio-group">
                <div class="radio-option">
                    <input type="radio" id="diabetes-yes" name="Diabetes" value="yes" required>
                    <label for="diabetes-yes">Yes</label>
                </div>
                <div class="radio-option">
                    <input type="radio" id="diabetes-no" name="Diabetes" value="no">
                    <label for="diabetes-no">No</label>
                </div>
            </div>
        </div>

        <div class="form-group">
            <label class="form-label">Do you have High blood pressure?</label>
            <div class="radio-group">
                <div class="radio-option">
                    <input type="radio" id="high-bp-yes" name="HighBloodPressure" value="yes" required>
                    <label for="high-bp-yes">Yes</label>
                </div>
                <div class="radio-option">
                    <input type="radio" id="high-bp-no" name="HighBloodPressure" value="no">
                    <label for="high-bp-no">No</label>
                </div>
            </div>
        </div>

        <div class="form-group">
            <label class="form-label">Do you have High cholesterol?</label>
            <div class="radio-group">
                <div class="radio-option">
                    <input type="radio" id="high-cholesterol-yes" name="HighCholesterol" value="yes" required>
                    <label for="high-cholesterol-yes">Yes</label>
                </div>
                <div class="radio-option">
                    <input type="radio" id="high-cholesterol-no" name="HighCholesterol" value="no">
                    <label for="high-cholesterol-no">No</label>
                </div>
            </div>
        </div>

        <div class="form-group">
            <label class="form-label">Do you have Anemia?</label>
            <div class="radio-group">
                <div class="radio-option">
                    <input type="radio" id="anemia-yes" name="Anemia" value="yes" required>
                    <label for="anemia-yes">Yes</label>
                </div>
                <div class="radio-option">
                    <input type="radio" id="anemia-no" name="Anemia" value="no">
                    <label for="anemia-no">No</label>
                </div>
            </div>
        </div>

        <div class="form-group">
            <label class="form-label">Do you have Depression or anxiety?</label>
            <div class="radio-group">
                <div class="radio-option">
                    <input type="radio" id="depression-yes" name="DepressionAnxiety" value="yes" required>
                    <label for="depression-yes">Yes</label>
                </div>
                <div class="radio-option">
                    <input type="radio" id="depression-no" name="DepressionAnxiety" value="no">
                    <label for="depression-no">No</label>
                </div>
            </div>
        </div>

        <div class="form-group">
            <label class="form-label">Do you have Heart disease?</label>
            <div class="radio-group">
                <div class="radio-option">
                    <input type="radio" id="heart-disease-yes" name="HeartDisease" value="yes" required>
                    <label for="heart-disease-yes">Yes</label>
                </div>
                <div class="radio-option">
                    <input type="radio" id="heart-disease-no" name="HeartDisease" value="no">
                    <label for="heart-disease-no">No</label>
                </div>
            </div>
        </div>

        <div class="form-group">
            <label class="form-label">Do you have Menstrual irregularities?</label>
            <div class="radio-group">
                <div class="radio-option">
                    <input type="radio" id="menstrual-yes" name="MenstrualIrregularities" value="yes" required>
                    <label for="menstrual-yes">Yes</label>
                </div>
                <div class="radio-option">
                    <input type="radio" id="menstrual-no" name="MenstrualIrregularities" value="no">
                    <label for="menstrual-no">No</label>
                </div>
            </div>
        </div>

        <div class="form-group">
            <label class="form-label">Do you have any Autoimmune diseases (e.g., lupus, rheumatoid arthritis)?</label>
            <div class="radio-group">
                <div class="radio-option">
                    <input type="radio" id="autoimmune-yes" name="AutoimmuneDiseases" value="yes" required>
                    <label for="autoimmune-yes">Yes</label>
                </div>
                <div class="radio-option">
                    <input type="radio" id="autoimmune-no" name="AutoimmuneDiseases" value="no">
                    <label for="autoimmune-no">No</label>
                </div>
            </div>
        </div>
    </div>
</div>



                <!-- Family History Section -->
<div class="assessment-section" id="family-history-section">
    <div class="section-header">
        <div class="section-icon">
            <i class="fas fa-users"></i>
        </div>
        <h2 class="section-title">Family History</h2>
    </div>

    <div class="section-content">
        <p class="section-question">Does anyone in your immediate family have the following?</p>
        
        <div class="form-group">
            <label class="form-label">Hypothyroidism</label>
            <div class="radio-group">
                <div class="radio-option">
                    <input type="radio" id="fh-hypothyroidism-yes" name="FH_Hypothyroidism" value="yes">
                    <label for="fh-hypothyroidism-yes">Yes</label>
                </div>
                <div class="radio-option">
                    <input type="radio" id="fh-hypothyroidism-no" name="FH_Hypothyroidism" value="no">
                    <label for="fh-hypothyroidism-no">No</label>
                </div>
            </div>
        </div>

        <div class="form-group">
            <label class="form-label">Hyperthyroidism</label>
            <div class="radio-group">
                <div class="radio-option">
                    <input type="radio" id="fh-hyperthyroidism-yes" name="FH_Hyperthyroidism" value="yes">
                    <label for="fh-hyperthyroidism-yes">Yes</label>
                </div>
                <div class="radio-option">
                    <input type="radio" id="fh-hyperthyroidism-no" name="FH_Hyperthyroidism" value="no">
                    <label for="fh-hyperthyroidism-no">No</label>
                </div>
            </div>
        </div>

        <div class="form-group">
            <label class="form-label">Goiter</label>
            <div class="radio-group">
                <div class="radio-option">
                    <input type="radio" id="fh-goiter-yes" name="FH_Goiter" value="yes">
                    <label for="fh-goiter-yes">Yes</label>
                </div>
                <div class="radio-option">
                    <input type="radio" id="fh-goiter-no" name="FH_Goiter" value="no">
                    <label for="fh-goiter-no">No</label>
                </div>
            </div>
        </div>

        <div class="form-group">
            <label class="form-label">Thyroid Cancer</label>
            <div class="radio-group">
                <div class="radio-option">
                    <input type="radio" id="fh-thyroid-cancer-yes" name="FH_ThyroidCancer" value="yes">
                    <label for="fh-thyroid-cancer-yes">Yes</label>
                </div>
                <div class="radio-option">
                    <input type="radio" id="fh-thyroid-cancer-no" name="FH_ThyroidCancer" value="no">
                    <label for="fh-thyroid-cancer-no">No</label>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Current Symptoms Section -->
<div class="assessment-section" id="current-symptoms-section">
    <div class="section-header">
        <div class="section-icon">
            <i class="fas fa-notes-medical"></i>
        </div>
        <h2 class="section-title">Current Symptoms</h2>
    </div>

    <div class="section-content">
        <p class="section-question">Are you currently experiencing any of these symptoms?</p>

        <div class="form-group">
            <label class="form-label">Fatigue or weakness</label>
            <div class="radio-group">
                <div class="radio-option">
                    <input type="radio" id="sym-fatigue-yes" name="Sym_Fatigue" value="yes">
                    <label for="sym-fatigue-yes">Yes</label>
                </div>
                <div class="radio-option">
                    <input type="radio" id="sym-fatigue-no" name="Sym_Fatigue" value="no">
                    <label for="sym-fatigue-no">No</label>
                </div>
            </div>
        </div>

        <div class="form-group">
            <label class="form-label">Unexplained weight gain/loss</label>
            <div class="radio-group">
                <div class="radio-option">
                    <input type="radio" id="sym-weight-yes" name="Sym_WeightChange" value="yes">
                    <label for="sym-weight-yes">Yes</label>
                </div>
                <div class="radio-option">
                    <input type="radio" id="sym-weight-no" name="Sym_WeightChange" value="no">
                    <label for="sym-weight-no">No</label>
                </div>
            </div>
        </div>

        <div class="form-group">
            <label class="form-label">Dry skin</label>
            <div class="radio-group">
                <div class="radio-option">
                    <input type="radio" id="sym-dryskin-yes" name="Sym_DrySkin" value="yes">
                    <label for="sym-dryskin-yes">Yes</label>
                </div>
                <div class="radio-option">
                    <input type="radio" id="sym-dryskin-no" name="Sym_DrySkin" value="no">
                    <label for="sym-dryskin-no">No</label>
                </div>
            </div>
        </div>

        <div class="form-group">
            <label class="form-label">Hair thinning or loss</label>
            <div class="radio-group">
                <div class="radio-option">
                    <input type="radio" id="sym-hairloss-yes" name="Sym_HairLoss" value="yes">
                    <label for="sym-hairloss-yes">Yes</label>
                </div>
                <div class="radio-option">
                    <input type="radio" id="sym-hairloss-no" name="Sym_HairLoss" value="no">
                    <label for="sym-hairloss-no">No</label>
                </div>
            </div>
        </div>

        <div class="form-group">
            <label class="form-label">Slow or fast heart rate</label>
            <div class="radio-group">
                <div class="radio-option">
                    <input type="radio" id="sym-heart-yes" name="Sym_HeartRate" value="yes">
                    <label for="sym-heart-yes">Yes</label>
                </div>
                <div class="radio-option">
                    <input type="radio" id="sym-heart-no" name="Sym_HeartRate" value="no">
                    <label for="sym-heart-no">No</label>
                </div>
            </div>
        </div>

        <div class="form-group">
            <label class="form-label">Constipation or diarrhea</label>
            <div class="radio-group">
                <div class="radio-option">
                    <input type="radio" id="sym-digest-yes" name="Sym_Digestion" value="yes">
                    <label for="sym-digest-yes">Yes</label>
                </div>
                <div class="radio-option">
                    <input type="radio" id="sym-digest-no" name="Sym_Digestion" value="no">
                    <label for="sym-digest-no">No</label>
                </div>
            </div>
        </div>

        <div class="form-group">
            <label class="form-label">Irregular periods</label>
            <div class="radio-group">
                <div class="radio-option">
                    <input type="radio" id="sym-periods-yes" name="Sym_IrregularPeriods" value="yes">
                    <label for="sym-periods-yes">Yes</label>
                </div>
                <div class="radio-option">
                    <input type="radio" id="sym-periods-no" name="Sym_IrregularPeriods" value="no">
                    <label for="sym-periods-no">No</label>
                </div>
            </div>
        </div>

        <div class="form-group">
            <label class="form-label">Swelling in the neck or goiter</label>
            <div class="radio-group">
                <div class="radio-option">
                    <input type="radio" id="sym-neck-yes" name="Sym_NeckSwelling" value="yes">
                    <label for="sym-neck-yes">Yes</label>
                </div>
                <div class="radio-option">
                    <input type="radio" id="sym-neck-no" name="Sym_NeckSwelling" value="no">
                    <label for="sym-neck-no">No</label>
                </div>
            </div>
        </div>

    </div>
</div>


<!-- Lab Results Section -->
<div class="assessment-section" id="lab-results-section">
  <div class="section-header">
    <div class="section-icon">
      <i class="fas fa-flask"></i>
    </div>
    <h2 class="section-title">Lab Results</h2>
  </div>

  <div class="section-content">

    <!-- TSH -->
    <div class="form-group">
      <label class="form-label">Have you had your TSH (Thyroid Stimulating Hormone) measured?</label>
      <div class="radio-group">
        <div class="radio-option">
          <input type="radio" id="tsh-yes" name="tsh" value="yes" onchange="toggleConditionalInput('tsh', this.value)" required>
          <label for="tsh-yes">Yes</label>
        </div>
        <div class="radio-option">
          <input type="radio" id="tsh-no" name="tsh" value="no" onchange="toggleConditionalInput('tsh', this.value)">
          <label for="tsh-no">No</label>
        </div>
      </div>
      <div class="conditional-input" id="tsh-input">
        <label class="form-label">What was your TSH level?</label>
        <!--  added name="tsh_value" -->
        <input type="number" step="any" name="tsh_value" class="form-input" placeholder="e.g., 2.5 mIU/L">
      </div>
    </div>

    <!-- T3 -->
    <div class="form-group">
      <label class="form-label">Have you had your T3 (Triiodothyronine) measured?</label>
      <div class="radio-group">
        <div class="radio-option">
          <input type="radio" id="t3-yes" name="t3" value="yes" onchange="toggleConditionalInput('t3', this.value)" required>
          <label for="t3-yes">Yes</label>
        </div>
        <div class="radio-option">
          <input type="radio" id="t3-no" name="t3" value="no" onchange="toggleConditionalInput('t3', this.value)">
          <label for="t3-no">No</label>
        </div>
      </div>
      <div class="conditional-input" id="t3-input">
        <label class="form-label">What was your T3 level?</label>
        <!--  added name="t3_value" -->
        <input type="number" step="any" name="t3_value" class="form-input" placeholder="e.g., 120 ng/dL">
      </div>
    </div>

    <!-- T4 -->
    <div class="form-group">
      <label class="form-label">Have you had your Total T4 measured?</label>
      <div class="radio-group">
        <div class="radio-option">
          <input type="radio" id="t4-yes" name="t4" value="yes" onchange="toggleConditionalInput('t4', this.value)" required>
          <label for="t4-yes">Yes</label>
        </div>
        <div class="radio-option">
          <input type="radio" id="t4-no" name="t4" value="no" onchange="toggleConditionalInput('t4', this.value)">
          <label for="t4-no">No</label>
        </div>
      </div>
      <div class="conditional-input" id="t4-input">
        <label class="form-label">What was your Total T4 level?</label>
        <!--  added name="t4_value" -->
        <input type="number" step="any" name="t4_value" class="form-input" placeholder="e.g., 8.5 ng/dL">
      </div>
    </div>

    <!-- T4 Uptake -->
    <div class="form-group">
      <label class="form-label">Have you had your T4 Uptake measured?</label>
      <div class="radio-group">
        <div class="radio-option">
          <input type="radio" id="t4-uptake-yes" name="t4-uptake" value="yes" onchange="toggleConditionalInput('t4-uptake', this.value)" required>
          <label for="t4-uptake-yes">Yes</label>
        </div>
        <div class="radio-option">
          <input type="radio" id="t4-uptake-no" name="t4-uptake" value="no" onchange="toggleConditionalInput('t4-uptake', this.value)">
          <label for="t4-uptake-no">No</label>
        </div>
      </div>
      <div class="conditional-input" id="t4-uptake-input">
        <label class="form-label">What was your T4 Uptake result?</label>
        <!--  added name="t4_uptake_value" -->
        <input type="number" step="any" name="t4_uptake_value" class="form-input" placeholder="e.g., 28%">
      </div>
    </div>

    <!-- FTI -->
    <div class="form-group">
      <label class="form-label">Have you had your Free Thyroxine Index (FTI) measured?</label>
      <div class="radio-group">
        <div class="radio-option">
          <input type="radio" id="fti-yes" name="fti" value="yes" onchange="toggleConditionalInput('fti', this.value)" required>
          <label for="fti-yes">Yes</label>
        </div>
        <div class="radio-option">
          <input type="radio" id="fti-no" name="fti" value="no" onchange="toggleConditionalInput('fti', this.value)">
          <label for="fti-no">No</label>
        </div>
      </div>
      <div class="conditional-input" id="fti-input">
        <label class="form-label">What was your FTI result?</label>
        <!-- added name="fti_value" -->
        <input type="number" step="any" name="fti_value" class="form-input" placeholder="e.g., 2.4">
      </div>
    </div>

  </div>
</div>



                </form>
            </div>

            <!-- Submit Section -->
            <div class="submit-section">
                <button class="submit-btn">
                    <i class="fas fa-paper-plane"></i>
                    Submit Assessment
                </button>
                <div class="validation-status" id="validation-status" style="display: none;">
                    <i class="fas fa-exclamation-triangle"></i>
                    Please complete all required fields and upload a photo before submitting.
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-bottom">
            <p>&copy; 2025 ThyroSight. All rights reserved.</p>
        </div>
    </footer>

    <!-- Logout Confirmation Modal -->
    <div class="logout-modal-overlay" id="logoutModal" style="display: none;">
        <div class="logout-modal">
            <div class="logout-modal-header">
                <div class="logout-icon">
                    <i class="fas fa-sign-out-alt"></i>
                </div>
                <h2>Confirm Logout</h2>
                <p>Are you sure you want to logout from your ThyroSight account? You'll need to login again to access your dashboard.</p>
            </div>
            <div class="logout-modal-actions">
                <button class="logout-btn cancel" onclick="hideLogoutModal()">Cancel</button>
                <button class="logout-btn confirm" onclick="confirmLogout()">Logout</button>
            </div>
        </div>
    </div>

<!-- Health Assessment Result Popup (Restored Full Version) -->
<div id="result-popup" class="result-popup-overlay" style="display: none;">
  <div class="result-popup">
    <div class="result-popup-header">
      <h2><i class="fas fa-chart-line"></i> Assessment Results</h2>
      <button class="close-popup" onclick="closeResultPopup()">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <!-- Add the mode badge directly under the header -->
    <div id="mode-badge" class="mode-badge"></div>
    <div id="ai-confidence-insights" class="ai-insights-box"></div>


    

    <div class="result-content">
      <!-- Thyroid Condition Result -->
      <div class="result-section condition-section">
        <div class="result-header">
          <i class="fas fa-heartbeat"></i>
          <h3>Thyroid Condition</h3>
        </div>
        <div class="condition-result" id="condition-result">
          <div class="condition-badge normal">
            <i class="fas fa-check-circle"></i>
            <span>Normal Thyroid Function</span>
          </div>
          <p class="condition-description" id="result-description">
            Based on your assessment, your thyroid function appears to be within normal ranges.
          </p>
        </div>
      </div>

      <!-- Confidence Score -->
      <div class="result-section">
        <div class="result-header">
          <i class="fas fa-percentage"></i>
          <h3>Confidence Score</h3>
        </div>
        <div class="confidence-display">
          <div class="confidence-circle">
            <div class="confidence-number">%</div>
          </div>
          <div class="confidence-info">
            <p>This prediction is based on calibrated Random Forest (Bagging) analysis of your assessment data.</p>
            <div class="confidence-bar">
              <div class="confidence-fill" style="width: 0%"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- SHAP Factors -->
      <div class="result-section">
        <div class="result-header">
          <i class="fas fa-chart-bar"></i>
          <h3>Key Factors Affecting Result</h3>
        </div>
        <div id="shap-factors" class="shap-factors">
          <!-- Default placeholders (replaced dynamically later) -->
          <div class="factor-item positive">
            <div class="factor-icon"><i class="fas fa-plus-circle"></i></div>
            <div class="factor-content">
              <h4>TSH Levels</h4>
              <p>Your TSH levels are within normal range (2.5 mIU/L)</p>
              <div class="factor-impact">+15%</div>
            </div>
          </div>

          <div class="factor-item positive">
            <div class="factor-icon"><i class="fas fa-plus-circle"></i></div>
            <div class="factor-content">
              <h4>No Thyroid Medication</h4>
              <p>You're not currently taking thyroid medication.</p>
              <div class="factor-impact">+12%</div>
            </div>
          </div>

          <div class="factor-item negative">
            <div class="factor-icon"><i class="fas fa-minus-circle"></i></div>
            <div class="factor-content">
              <h4>Family History</h4>
              <p>No family history of thyroid conditions.</p>
              <div class="factor-impact">+8%</div>
            </div>
          </div>

          <div class="factor-item neutral">
            <div class="factor-icon"><i class="fas fa-equals"></i></div>
            <div class="factor-content">
              <h4>Age Factor</h4>
              <p>Your age group shows typical thyroid patterns.</p>
              <div class="factor-impact">+5%</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Health Tips -->
      <div class="result-section">
        <div class="result-header">
          <i class="fas fa-lightbulb"></i>
          <h3>Health Tips</h3>
        </div>
        <div class="health-tips" id="health-tips">
          <!-- Default placeholders -->
          <div class="tip-item">
            <div class="tip-icon"><i class="fas fa-utensils"></i></div>
            <div class="tip-content">
              <h4>Maintain Balanced Diet</h4>
              <p>Include iodine-rich foods like fish, dairy, and iodized salt in moderation.</p>
            </div>
          </div>

          <div class="tip-item">
            <div class="tip-icon"><i class="fas fa-dumbbell"></i></div>
            <div class="tip-content">
              <h4>Regular Exercise</h4>
              <p>Engage in moderate physical activity for at least 30 minutes daily.</p>
            </div>
          </div>

          <div class="tip-item">
            <div class="tip-icon"><i class="fas fa-bed"></i></div>
            <div class="tip-content">
              <h4>Quality Sleep</h4>
              <p>Ensure 79 hours of quality sleep to support thyroid function.</p>
            </div>
          </div>

          <div class="tip-item">
            <div class="tip-icon"><i class="fas fa-calendar-check"></i></div>
            <div class="tip-content">
              <h4>Regular Check-ups</h4>
              <p>Schedule annual thyroid function tests to monitor your health.</p>
            </div>
          </div>
        </div>
      </div>



  </div>
</div>



    <script>
        // Helper function to get form data
        function getFormData() {
            const formData = {};

            // Get radio button values
            const radioFields = [
                // Medical History
                'thyroxine', 'advised-thyroxine', 'antithyroid', 'illness', 'pregnant', 
                'surgery', 'radioactive', 'hypo-suspected', 'hyper-suspected', 'lithium', 
                'goitre', 'tumor', 'hypopituitarism', 'psychiatric', 'tsh', 't3', 't4', 
                't4-uptake', 'fti',
                // Other Medical Conditions
                'Diabetes', 'HighBloodPressure', 'HighCholesterol', 'Anemia', 
                'DepressionAnxiety', 'HeartDisease', 'MenstrualIrregularities', 'AutoimmuneDiseases',
                // Family History
                'FH_Hypothyroidism', 'FH_Hyperthyroidism', 'FH_Goiter', 'FH_ThyroidCancer',
                // Current Symptoms
                'Sym_Fatigue', 'Sym_WeightChange', 'Sym_DrySkin', 'Sym_HairLoss', 'Sym_HeartRate',
                'Sym_Digestion', 'Sym_IrregularPeriods', 'Sym_NeckSwelling'
            ];

            radioFields.forEach(field => {
                const selected = document.querySelector(`input[name="${field}"]:checked`);
                formData[field] = selected ? selected.value : 'no'; // default to 'no'
            });

            // Get input values for lab tests
            const conditionalFields = ['tsh', 't3', 't4', 't4-uptake', 'fti'];
            conditionalFields.forEach(field => {
                const inputContainer = document.getElementById(field + '-input');
                if (inputContainer) {
                    const input = inputContainer.querySelector('input');
                    if (input) {
                        formData[field + 'Value'] = input.value.trim();
                    }
                }
            });

            // Get age and gender
            const ageField = document.getElementById('calculated-age');
            if (ageField && ageField.value) {
                const ageMatch = ageField.value.match(/\d+/);
                formData.age = ageMatch ? parseInt(ageMatch[0]) : 0;
            } else {
                formData.age = 0;
            }

            const genderField = document.getElementById('gender-display');
            if (genderField && genderField.value) {
                formData.gender = genderField.value.toLowerCase();
            } else {
                formData.gender = 'unknown';
            }

            return formData;
        }

        // Fetch and populate user data automatically
        async function fetchUserData() {
            try {
                const response = await fetch('get-user-data.php');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    const userData = result.data;
                    
                    // Check if profile is complete
                    const isProfileComplete = userData.birthdate && userData.gender && userData.age !== null;
                    
                    // Format birthdate for display
                    if (userData.birthdate) {
                        const birthdate = new Date(userData.birthdate);
                        const formattedDate = birthdate.toLocaleDateString('en-US', {
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric'
                        });
                        document.getElementById('birthdate').value = formattedDate;
                    } else {
                        document.getElementById('birthdate').value = 'Profile incomplete - Please update your profile';
                    }
                    
                    // Display age
                    if (userData.age !== null) {
                        document.getElementById('calculated-age').value = userData.age + ' years old';
                    } else {
                        document.getElementById('calculated-age').value = 'Profile incomplete - Please update your profile';
                    }
                    
                    // Display gender
                    if (userData.gender) {
                        const capitalizedGender = userData.gender.charAt(0).toUpperCase() + userData.gender.slice(1);
                        document.getElementById('gender-display').value = capitalizedGender;
                    } else {
                        document.getElementById('gender-display').value = 'Profile incomplete - Please update your profile';
                    }

                    // Show/hide profile completion notice
                    const profileNotice = document.getElementById('profile-notice');
                    if (profileNotice) {
                        profileNotice.style.display = isProfileComplete ? 'none' : 'block';
                    }
                } else {
                    console.error('Failed to fetch user data:', result.error);
                    
                    // Handle specific error cases
                    if (result.error === 'User not logged in') {
                        // Don't redirect, just show the form without profile data
                        console.log('User not logged in, showing form without profile data');
                        return;
                    }
                    
                    // Set helpful error messages
                    const errorMessage = result.message || 'Unable to load profile data';
                    document.getElementById('birthdate').value = errorMessage;
                    document.getElementById('calculated-age').value = errorMessage;
                    document.getElementById('gender-display').value = errorMessage;
                    
                    // Show user-friendly notification
                    showNotification(errorMessage, 'warning');
                }
            } catch (error) {
                console.error('Error fetching user data:', error);
                
                // Check if it's a network error
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    const errorMessage = 'Network error - Please check your connection';
                    document.getElementById('birthdate').value = errorMessage;
                    document.getElementById('calculated-age').value = errorMessage;
                    document.getElementById('gender-display').value = errorMessage;
                    showNotification(errorMessage, 'error');
                } else {
                    const errorMessage = 'System error - Please try again later';
                    document.getElementById('birthdate').value = errorMessage;
                    document.getElementById('calculated-age').value = errorMessage;
                    document.getElementById('gender-display').value = errorMessage;
                    showNotification(errorMessage, 'error');
                }
            }
        }

        // Show user-friendly notifications
        function showNotification(message, type = 'info') {
            // Remove existing notifications
            const existingNotifications = document.querySelectorAll('.notification');
            existingNotifications.forEach(notification => notification.remove());
            
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'}"></i>
                    <span>${message}</span>
                <button onclick="this.parentElement.remove()" class="notification-close">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            // Add to page
            document.body.appendChild(notification);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }

        // Toggle conditional input fields
        function toggleConditionalInput(fieldName, value) {
            const inputContainer = document.getElementById(fieldName + '-input');
            if (inputContainer) {
            if (value === 'yes') {
                    inputContainer.style.display = 'block';
                inputContainer.classList.add('show');
            } else {
                    inputContainer.style.display = 'none';
                inputContainer.classList.remove('show');
            }
            }
        }

        function validateForm() {
            const requiredFields = [
                'thyroxine', 'advised-thyroxine', 'antithyroid', 'illness', 'pregnant', 
                'surgery', 'radioactive', 'hypo-suspected', 'hyper-suspected', 'lithium', 
                'goitre', 'tumor', 'hypopituitarism', 'psychiatric', 'tsh', 't3', 't4', 
                't4-uptake', 'fti'
            ];

            const missingFields = [];
            
            requiredFields.forEach(fieldName => {
                const selectedValue = document.querySelector(`input[name="${fieldName}"]:checked`);
                if (!selectedValue) {
                    missingFields.push(fieldName.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase()));
                }
            });

            if (missingFields.length > 0) {
                showNotification(`Please complete all required questions before submitting.`, 'warning');
                return false;
            }

            // Check conditional inputs for "Yes" answers (only for Lab Results)
            const conditionalFields = [
                'tsh', 't3', 't4', 't4-uptake', 'fti'
            ];

            conditionalFields.forEach(fieldName => {
                const selectedValue = document.querySelector(`input[name="${fieldName}"]:checked`);
                if (selectedValue && selectedValue.value === 'yes') {
                    const inputContainer = document.getElementById(fieldName + '-input');
                    if (inputContainer) {
                        const input = inputContainer.querySelector('input');
                        if (input && !input.value.trim()) {
                            missingFields.push(`${fieldName.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase())} details`);
                        }
                    }
                }
            });

            if (missingFields.length > 0) {
                showNotification(`Please fill in required details for questions marked "Yes".`, 'warning');
                return false;
            }

            return true;
        }

        // Update validation status (called by form field listeners)
        function updateValidationStatus() {
            // This function is called when form fields change
            // It updates the visual state but doesn't disable the submit button
            // Validation only happens on submit
            
            // Check if form is complete (without showing highlights)
            const complete = isFormComplete(false);
            
            // Update validation status message visibility (but don't show it unless submitting)
            const validationStatus = document.getElementById('validation-status');
            if (validationStatus && validationStatus.classList.contains('show')) {
                // Only update if already showing (during submit validation)
                if (complete) {
                    validationStatus.classList.remove('show');
                    // Also remove incomplete highlights when form becomes complete
                    document.querySelectorAll('.form-group').forEach(group => {
                        group.classList.remove('incomplete');
                    });
                    document.getElementById('photo-upload-section')?.classList.remove('incomplete');
                }
            }
            
            // Note: We don't disable the submit button here
            // The button is always enabled, validation happens on submit
        }

        // Add validation event listeners to all form fields
        function addFormValidationListeners() {
            // Add real-time validation for all required fields
            const requiredRadios = [
                'Diabetes', 'HighBloodPressure', 'HighCholesterol', 'Anemia', 'DepressionAnxiety', 'HeartDisease', 'MenstrualIrregularities', 'AutoimmuneDiseases',
                'FH_Hypothyroidism', 'FH_Hyperthyroidism', 'FH_Goiter', 'FH_ThyroidCancer',
                'Sym_Fatigue', 'Sym_WeightChange', 'Sym_DrySkin', 'Sym_HairLoss', 'Sym_HeartRate', 'Sym_Digestion', 'Sym_IrregularPeriods', 'Sym_NeckSwelling',
                'tsh', 't3', 't4', 't4-uptake', 'fti'
            ];

            // Add listeners to all radio buttons
            requiredRadios.forEach(fieldName => {
                const radios = document.querySelectorAll(`input[name="${fieldName}"]`);
                radios.forEach(radio => {
                    radio.addEventListener('change', updateValidationStatus);
                });
            });

            // Add listeners to conditional inputs
            const conditionalFields = ['tsh', 't3', 't4', 't4-uptake', 'fti'];
            conditionalFields.forEach(field => {
                const inputContainer = document.getElementById(field + '-input');
                if (inputContainer) {
                    const input = inputContainer.querySelector('input');
                    if (input) {
                        input.addEventListener('input', updateValidationStatus);
                        input.addEventListener('blur', updateValidationStatus);
                    }
                }
            });

            // Add listener for photo upload
            const photoInput = document.getElementById('photo-input');
            if (photoInput) {
                photoInput.addEventListener('change', updateValidationStatus);
            }

            // Note: No initial validation check - highlights only show on submit
        }

        // Check if form is complete (all required fields filled and photo uploaded)
        // showHighlights parameter controls whether to add visual highlighting
        function isFormComplete(showHighlights = false) {
            let isComplete = true;
            
            // Reset all incomplete styling only if we're showing highlights
            if (showHighlights) {
                document.querySelectorAll('.form-group').forEach(group => {
                    group.classList.remove('incomplete');
                });
                document.getElementById('photo-upload-section')?.classList.remove('incomplete');
            }
            
            // Check if photo is uploaded
            const uploadedPhoto = document.getElementById('uploaded-photo');
            if (!uploadedPhoto || uploadedPhoto.style.display === 'none') {
                isComplete = false;
                // Highlight photo upload section only if showHighlights is true
                if (showHighlights) {
                    const photoSection = document.getElementById('photo-upload-section');
                    if (photoSection) {
                        photoSection.classList.add('incomplete');
                    }
                }
            }
            
            // Check all required radio button groups
            const requiredFields = ['thyroxine', 'advised-thyroxine', 'antithyroid', 'illness', 'pregnant', 
                                   'surgery', 'radioactive', 'hypo-suspected', 'hyper-suspected', 'lithium', 
                                   'goitre', 'tumor', 'hypopituitarism', 'psychiatric', 'tsh', 't3', 't4', 
                                   't4-uptake', 'fti'];
            
            for (let field of requiredFields) {
                const selected = document.querySelector(`input[name="${field}"]:checked`);
                if (!selected) {
                    isComplete = false;
                    // Find and highlight the incomplete field group only if showHighlights is true
                    if (showHighlights) {
                        const fieldGroup = document.querySelector(`input[name="${field}"]`)?.closest('.form-group');
                        if (fieldGroup) {
                            fieldGroup.classList.add('incomplete');
                        }
                    }
                }
            }
            
            // Check conditional input fields (if "yes" is selected, the text input must be filled)
            const conditionalFields = ['tsh', 't3', 't4', 't4-uptake', 'fti'];
            for (let field of conditionalFields) {
                const radioYes = document.querySelector(`input[name="${field}"][value="yes"]`);
                if (radioYes && radioYes.checked) {
                    const inputContainer = document.getElementById(field + '-input');
                    if (inputContainer) {
                        const input = inputContainer.querySelector('input');
                        if (input && !input.value.trim()) {
                            isComplete = false;
                            // Highlight the incomplete conditional input only if showHighlights is true
                            if (showHighlights) {
                                const fieldGroup = input.closest('.form-group');
                                if (fieldGroup) {
                                    fieldGroup.classList.add('incomplete');
                                }
                            }
                        }
                    }
                }
            }
            
            return isComplete;
        }

        // // Update submit button state based on form completion
        // function updateSubmitButtonState() {
        //     // This function is now only called on submit, not in real-time
        //     const submitBtn = document.querySelector('.submit-btn');
        //     const validationStatus = document.getElementById('validation-status');
            
        //     if (submitBtn) {
        //         if (isFormComplete()) {
        //             submitBtn.disabled = false;
        //             submitBtn.style.opacity = '1';
        //             submitBtn.style.cursor = 'pointer';
        //             if (validationStatus) {
        //                 validationStatus.classList.remove('show');
        //             }
        //         } else {
        //             submitBtn.disabled = true;
        //             submitBtn.style.opacity = '0.6';
        //             submitBtn.style.cursor = 'not-allowed';
        //             if (validationStatus) {
        //                 validationStatus.classList.add('show');
        //             }
        //         }
        //     }
        // }

        // Scroll to first incomplete field
        function scrollToFirstIncomplete() {
            const firstIncomplete = document.querySelector('.form-group.incomplete, #photo-upload-section.incomplete');
            if (firstIncomplete) {
                firstIncomplete.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'center' 
                });
                // Add a flash effect
                firstIncomplete.style.animation = 'flash-highlight 1s ease-in-out';
                setTimeout(() => {
                    firstIncomplete.style.animation = '';
                }, 1000);
            }
        }

        // // Submit health assessment
        // function submitAssessment() {
        //     console.log('Submit button clicked!'); // Debug log
            
        //     // Test if we can access DOM elements
        //     console.log('Testing DOM access...');
        //     console.log('Document ready state:', document.readyState);
            
        //     // Validate form
        //     const form = document.getElementById('health-assessment-form');
        //     console.log('Form element:', form);
            
        //     if (!form) {
        //         console.error('Form not found!');
        //         alert('Error: Form not found. Please refresh the page.');
        //         return;
        //     }

        //     // Check if form is complete
        //     if (!isFormComplete()) {
        //         // Show validation message and scroll to first incomplete field
        //         const validationStatus = document.getElementById('validation-status');
        //         if (validationStatus) {
        //             validationStatus.classList.add('show');
        //         }
        //         scrollToFirstIncomplete();
        //         return;
        //     }
            
        //     // Show loading state
        //     const submitBtn = document.querySelector('.submit-btn');
        //     console.log('Submit button element:', submitBtn);
            
        //     if (!submitBtn) {
        //         console.error('Submit button not found!');
        //         return;
        //     }
            
        //     const originalText = submitBtn.innerHTML;
        //     submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
        //     submitBtn.disabled = true;
            
        //     // Simulate processing time
        //     setTimeout(() => {
        //         try {
        //             console.log('Starting result generation...');
                    
        //             // Generate mock results
        //             const results = generateMockResults();
        //             console.log('Results generated:', results); // Debug log
                    
        //             // Store results globally for saving
        //             window.currentAssessmentResults = results;
                    
        //             // Store current timestamp as form ID (you can modify this based on your form submission logic)
        //             window.currentFormId = Date.now();
                    
        //             console.log('About to display results...');
                    
        //             // Display results
        //             displayResults(results);
                    
        //             // Reset button
        //             submitBtn.innerHTML = originalText;
        //             submitBtn.disabled = false;
                    
        //             console.log('Assessment completed successfully!'); // Debug log
        //         } catch (error) {
        //             console.error('Error in submitAssessment:', error);
        //             console.error('Error stack:', error.stack);
        //             alert('An error occurred while processing your assessment. Please try again.\nError: ' + error.message);
                    
        //             // Reset button on error
        //             submitBtn.innerHTML = originalText;
        //             submitBtn.disabled = false;
        //         }
        //     }, 2000);
        // }

        // Generate mock results for demonstration
        function generateMockResults() {
            // Get actual form values to make results more realistic
            const formData = getFormData();
            const ageField = document.getElementById('calculated-age');
            const age = ageField ? parseInt(ageField.value) || 30 : 30;
            
            let condition, confidence, description;
            let riskFactors = [];
            
            // Analyze TSH levels if available
            if (formData.tsh === 'yes' && formData.tshValue) {
                const tshValue = parseFloat(formData.tshValue);
                if (tshValue < 0.4) {
                    condition = 'hyper';
                    confidence = Math.floor(Math.random() * 15) + 80; // 80-94%
                    description = 'Your assessment indicates possible hyperthyroidism. Your TSH level is below normal range, which requires immediate medical attention.';
                    riskFactors = ['Low TSH levels', 'Possible overactive thyroid', 'Requires medical evaluation'];
                } else if (tshValue > 4.0) {
                    condition = 'hypo';
                    confidence = Math.floor(Math.random() * 15) + 80; // 80-94%
                    description = 'Your assessment suggests hypothyroidism. Your elevated TSH level indicates an underactive thyroid that requires medical evaluation.';
                    riskFactors = ['High TSH levels', 'Possible underactive thyroid', 'Requires medical evaluation'];
                } else {
                    condition = 'normal';
                    confidence = Math.floor(Math.random() * 15) + 75; // 75-89%
                    description = 'Excellent! Your TSH level is within normal range, indicating healthy thyroid function.';
                }
            }
            // Analyze medication use
            else if (formData.thyroxine === 'yes') {
                condition = 'hypo';
                confidence = Math.floor(Math.random() * 15) + 80; // 80-94%
                description = 'You are currently managing hypothyroidism with medication. Your assessment confirms this diagnosis, and it\'s important to continue your treatment plan.';
                riskFactors = ['Current medication use', 'Previous diagnosis', 'Ongoing management'];
            }
            // Analyze medical history
            else if (formData.surgery === 'yes' || formData.radioactive === 'yes' || formData.tumor === 'yes') {
                condition = 'hypo';
                confidence = Math.floor(Math.random() * 15) + 75; // 75-89%
                description = 'Your medical history indicates previous thyroid treatment. Regular monitoring is essential to maintain optimal thyroid function.';
                riskFactors = ['Previous thyroid treatment', 'Surgical history', 'Requires ongoing monitoring'];
            }
            // Analyze doctor suspicions
            else if (formData.hypo_suspected === 'yes') {
                condition = 'hypo';
                confidence = Math.floor(Math.random() * 15) + 70; // 70-84%
                description = 'Your doctor previously suspected hypothyroidism. This assessment supports that suspicion and recommends further medical evaluation.';
                riskFactors = ['Previous medical suspicion', 'Clinical indicators', 'Requires confirmation'];
            }
            else if (formData.hyper_suspected === 'yes') {
                condition = 'hyper';
                confidence = Math.floor(Math.random() * 15) + 70; // 70-84%
                description = 'Your doctor previously suspected hyperthyroidism. This assessment supports that suspicion and recommends immediate medical evaluation.';
                riskFactors = ['Previous medical suspicion', 'Clinical indicators', 'Requires confirmation'];
            }
            // Analyze other risk factors
            else if (formData.lithium === 'yes') {
                condition = 'hypo';
                confidence = Math.floor(Math.random() * 15) + 70; // 70-84%
                description = 'Lithium medication can cause hypothyroidism as a side effect. Regular thyroid monitoring is recommended while on this medication.';
                riskFactors = ['Lithium medication', 'Known side effect', 'Requires monitoring'];
            }
            else if (formData.goitre === 'yes') {
                condition = 'hypo';
                confidence = Math.floor(Math.random() * 15) + 65; // 65-79%
                description = 'Previous goitre diagnosis indicates thyroid gland abnormalities. Regular monitoring is recommended to assess current function.';
                riskFactors = ['Goitre history', 'Thyroid abnormalities', 'Requires monitoring'];
            }
            // Default to normal if no significant risk factors
            else {
                condition = 'normal';
                confidence = Math.floor(Math.random() * 15) + 70; // 70-84%
                description = 'Your assessment shows normal thyroid function. Your responses indicate healthy thyroid patterns and no concerning risk factors.';
            }

            // Generate enhanced SHAP factors based on actual form data
            const shapResult = generateEnhancedSHAPFactors(condition, age, riskFactors);
            
            // Extract factors from result (handle both old and new format)
            const factors = shapResult && shapResult.factors ? shapResult.factors : shapResult;
            
            // Generate personalized health tips based on actual form data
            const tips = generatePersonalizedHealthTips(condition, age, riskFactors);
            
            return {
                condition,
                confidence,
                description,
                factors,
                tips,
                riskFactors
            };
        }

        // Generate enhanced SHAP factors with more detail - FIXED LOGIC
        // CORRECTED generateEnhancedSHAPFactors function
        // This function now properly categorizes factors based on the predicted condition
        // Positive factors = contribute TO the diagnosis
        // Negative factors = contradict the diagnosis

// ========================================
// ENHANCED SHAP FACTORS GENERATION
// Analyzes ALL user inputs and generates comprehensive factors
// ========================================

        function generateEnhancedSHAPFactors(condition, age, riskFactors) {
            const factors = [];
            const formData = getFormData();

            console.log(' Generating COMPREHENSIVE SHAP factors for condition:', condition);
            console.log(' Form Data:', formData);

            // ========================================
            // 1. LAB RESULTS ANALYSIS (TSH, T3, T4, FTI, T4 Uptake)
            // ========================================
            
            // TSH Analysis
            if (formData.tsh === 'yes' && formData.tshValue) {
                const tshValue = parseFloat(formData.tshValue);
                
                if (tshValue < 0.4) {
                    // Low TSH indicates hyperthyroidism
                    if (condition === 'hyper') {
                        factors.push({
                            name: 'TSH Levels (Low)',
                            description: `Your TSH level is ${tshValue} mIU/L (below normal <0.4).`,
                            impact: 25,
                            type: 'positive'
                        });
                    } else {
                        factors.push({
                            name: 'TSH Levels (Low)',
                            description: `Your TSH level is ${tshValue} mIU/L (below normal <0.4).`,
                            impact: -22,
                            type: 'negative'
                        });
                    }
                } else if (tshValue > 4.0) {
                    // High TSH indicates hypothyroidism
                    if (condition === 'hypo') {
                        factors.push({
                            name: 'TSH Levels (High)',
                            description: `Your TSH level is ${tshValue} mIU/L, which is above the normal range. Elevated TSH indicates your pituitary is working harder to stimulate an underactive thyroid.`,
                            impact: 25,
                            type: 'positive'
                        });
                    } else {
                        factors.push({
                            name: 'TSH Levels (High)',
                            description: `Your TSH level is ${tshValue} mIU/L, which is above the normal range. Elevated TSH indicates your pituitary is working harder to stimulate an underactive thyroid.`,
                            impact: -22,
                            type: 'negative'
                        });
                    }
                } else {
                    // Normal TSH (0.4-4.0)
                    if (condition === 'normal') {
                        factors.push({
                            name: 'TSH Levels (Normal)',
                            description: `Your TSH level is ${tshValue} mIU/L (normal range: 0.4-4.0).`,
                            impact: 18,
                            type: 'positive'
                        });
                    } else {
                        factors.push({
                            name: 'TSH Levels (Normal Range)',
                            description: `Your TSH level is ${tshValue} mIU/L (normal range: 0.4-4.0).`,
                            impact: -15,
                            type: 'negative'
                        });
                    }
                }
            }

            // T3 Analysis
            if (formData.t3 === 'yes' && formData.t3Value) {
                const t3Value = parseFloat(formData.t3Value);
                const isNormal = t3Value >= 80 && t3Value <= 200;

                if (isNormal) {
                    if (condition === 'normal') {
                        factors.push({
                            name: 'T3 Levels (Normal)',
                            description: `Your T3 level is ${t3Value} ng/dL (normal range: 80-200).`,
                            impact: 14,
                            type: 'positive'
                        });
                    } else {
                        factors.push({
                            name: 'T3 Levels (Normal Range)',
                            description: `Your T3 level is ${t3Value} ng/dL (normal range: 80-200).`,
                            impact: -12,
                            type: 'negative'
                        });
                    }
                } else if (t3Value > 200) {
                    if (condition === 'hyper') {
                        factors.push({
                            name: 'T3 Levels (High)',
                            description: `Your T3 level is ${t3Value} ng/dL (above normal >200).`,
                            impact: 20,
                            type: 'positive'
                        });
                    } else {
                        factors.push({
                            name: 'T3 Levels (Elevated)',
                            description: `Your T3 level is ${t3Value} ng/dL (above normal >200).`,
                            impact: -18,
                            type: 'negative'
                        });
                    }
                } else {
                    if (condition === 'hypo') {
                        factors.push({
                            name: 'T3 Levels (Low)',
                            description: `Your T3 level is ${t3Value} ng/dL (below normal <80).`,
                            impact: 20,
                            type: 'positive'
                        });
                    } else {
                        factors.push({
                            name: 'T3 Levels (Below Normal)',
                            description: `Your T3 level is ${t3Value} ng/dL (below normal <80).`,
                            impact: -18,
                            type: 'negative'
                        });
                    }
                }
            }

            // T4 Analysis
            if (formData.t4 === 'yes' && formData.t4Value) {
                const t4Value = parseFloat(formData.t4Value);
                const isNormal = t4Value >= 4.5 && t4Value <= 12.5;

                if (isNormal) {
                    if (condition === 'normal') {
                        factors.push({
                            name: 'T4 Levels (Normal)',
                            description: `Your T4 level is ${t4Value} ng/dL (normal range: 4.5-12.5).`,
                            impact: 14,
                            type: 'positive'
                        });
                    } else {
                        factors.push({
                            name: 'T4 Levels (Normal Range)',
                            description: `Your T4 level is ${t4Value} ng/dL (normal range: 4.5-12.5).`,
                            impact: -12,
                            type: 'negative'
                        });
                    }
                } else if (t4Value > 12.5) {
                    if (condition === 'hyper') {
                        factors.push({
                            name: 'T4 Levels (High)',
                            description: `Your T4 level is ${t4Value} ng/dL (above normal >12.5).`,
                            impact: 18,
                            type: 'positive'
                        });
                    } else {
                        factors.push({
                            name: 'T4 Levels (Elevated)',
                            description: `Your T4 level is ${t4Value} ng/dL (above normal >12.5).`,
                            impact: -16,
                            type: 'negative'
                        });
                    }
                } else {
                    if (condition === 'hypo') {
                        factors.push({
                            name: 'T4 Levels (Low)',
                            description: `Your T4 level is ${t4Value} ng/dL (below normal <4.5).`,
                            impact: 18,
                            type: 'positive'
                        });
                    } else {
                        factors.push({
                            name: 'T4 Levels (Below Normal)',
                            description: `Your T4 level is ${t4Value} ng/dL (below normal <4.5).`,
                            impact: -16,
                            type: 'negative'
                        });
                    }
                }
            }

            // FTI Analysis
            if (formData.fti === 'yes' && formData.ftiValue) {
                const ftiValue = parseFloat(formData.ftiValue);
                const isNormal = ftiValue >= 1.0 && ftiValue <= 4.0;

                if (isNormal) {
                    if (condition === 'normal') {
                        factors.push({
                            name: 'Free Thyroxine Index (Normal)',
                            description: `Your FTI is ${ftiValue}, within normal range (1.0-4.0), indicating balanced thyroid hormone availability.`,
                            impact: 12,
                            type: 'positive'
                        });
                    }
                } else if (ftiValue > 4.0) {
                    if (condition === 'hyper') {
                        factors.push({
                            name: 'Free Thyroxine Index (High)',
                            description: `Your FTI is ${ftiValue} (above normal >4.0), indicating excess free thyroid hormone consistent with hyperthyroidism.`,
                            impact: 15,
                            type: 'positive'
                        });
                    }
                } else {
                    if (condition === 'hypo') {
                        factors.push({
                            name: 'Free Thyroxine Index (Low)',
                            description: `Your FTI is ${ftiValue} (below normal <1.0), indicating insufficient free thyroid hormone consistent with hypothyroidism.`,
                            impact: 15,
                            type: 'positive'
                        });
                    }
                }
            }

            // T4 Uptake Analysis
            if (formData['t4-uptake'] === 'yes' && formData['t4-uptakeValue']) {
                const t4UptakeValue = parseFloat(formData['t4-uptakeValue']);
                const isNormal = t4UptakeValue >= 25 && t4UptakeValue <= 35;

                if (isNormal) {
                    if (condition === 'normal') {
                        factors.push({
                            name: 'T4 Uptake (Normal)',
                            description: `Your T4 Uptake is ${t4UptakeValue}%, within normal range (25-35%), supporting healthy thyroid binding protein levels.`,
                            impact: 10,
                            type: 'positive'
                        });
                    }
                } else if (t4UptakeValue > 35) {
                    if (condition === 'hyper') {
                        factors.push({
                            name: 'T4 Uptake (High)',
                            description: `Your T4 Uptake is ${t4UptakeValue}% (above normal >35%), consistent with hyperthyroidism.`,
                            impact: 12,
                            type: 'positive'
                        });
                    }
                } else {
                    if (condition === 'hypo') {
                        factors.push({
                            name: 'T4 Uptake (Low)',
                            description: `Your T4 Uptake is ${t4UptakeValue}% (below normal <25%), consistent with hypothyroidism.`,
                            impact: 12,
                            type: 'positive'
                        });
                    }
                }
            }

            // ========================================
            // 2. MEDICAL HISTORY ANALYSIS
            // ========================================

            // Diabetes
            if (formData.Diabetes === 'yes' || formData.diabetes === 'yes') {
                if (condition !== 'normal') {
                    factors.push({
                        name: 'Diabetes History',
                        description: 'You have diabetes history.',
                        impact: 8,
                        type: 'positive'
                    });
                }
            }

            // High Blood Pressure
            if (formData.HighBloodPressure === 'yes' || formData.high_blood_pressure === 'yes') {
                if (condition === 'hyper') {
                    factors.push({
                        name: 'High Blood Pressure',
                        description: 'You have high blood pressure.',
                        impact: 10,
                        type: 'positive'
                    });
                } else if (condition === 'hypo') {
                    factors.push({
                        name: 'High Blood Pressure',
                        description: 'You have high blood pressure.',
                        impact: 6,
                        type: 'positive'
                    });
                }
            }

            // High Cholesterol
            if (formData.HighCholesterol === 'yes' || formData.high_cholesterol === 'yes') {
                if (condition === 'hypo') {
                    factors.push({
                        name: 'High Cholesterol',
                        description: 'You have high cholesterol.',
                        impact: 12,
                        type: 'positive'
                    });
                }
            }

            // Anemia
            if (formData.Anemia === 'yes' || formData.anemia === 'yes') {
                if (condition === 'hypo') {
                    factors.push({
                        name: 'Anemia',
                        description: 'You have anemia.',
                        impact: 10,
                        type: 'positive'
                    });
                }
            }

            // Depression/Anxiety
            if (formData.DepressionAnxiety === 'yes' || formData.depression_anxiety === 'yes') {
                if (condition === 'hypo') {
                    factors.push({
                        name: 'Depression/Anxiety',
                        description: 'You experience depression or anxiety.',
                        impact: 11,
                        type: 'positive'
                    });
                } else if (condition === 'hyper') {
                    factors.push({
                        name: 'Anxiety',
                        description: 'You experience anxiety.',
                        impact: 11,
                        type: 'positive'
                    });
                }
            }

            // Heart Disease
            if (formData.HeartDisease === 'yes' || formData.heart_disease === 'yes') {
                if (condition === 'hyper') {
                    factors.push({
                        name: 'Heart Disease',
                        description: 'You have heart disease.',
                        impact: 13,
                        type: 'positive'
                    });
                } else if (condition === 'hypo') {
                    factors.push({
                        name: 'Heart Disease',
                        description: 'You have heart disease.',
                        impact: 9,
                        type: 'positive'
                    });
                }
            }

            // Menstrual Irregularities
            if (formData.MenstrualIrregularities === 'yes' || formData.menstrual_irregularities === 'yes') {
                if (condition !== 'normal') {
                    factors.push({
                        name: 'Menstrual Irregularities',
                        description: 'You have menstrual irregularities.',
                        impact: 10,
                        type: 'positive'
                    });
                }
            }

            // Autoimmune Diseases
            if (formData.AutoimmuneDiseases === 'yes' || formData.autoimmune_diseases === 'yes') {
                if (condition !== 'normal') {
                    factors.push({
                        name: 'Autoimmune Disease History',
                        description: 'You have other autoimmune diseases. Thyroid disorders (especially Hashimoto\'s and Graves\' disease) are autoimmune conditions that often cluster with other autoimmune diseases.',
                        impact: 14,
                        type: 'positive'
                    });
                }
            }

            // ========================================
            // 3. FAMILY HISTORY ANALYSIS
            // ========================================

            if (formData.FH_Hypothyroidism === 'yes' || formData.fh_hypothyroidism === 'yes') {
                if (condition === 'hypo') {
                    factors.push({
                        name: 'Family History of Hypothyroidism',
                        description: 'Family history of hypothyroidism. Genetic factors significantly increase your risk.',
                        impact: 15,
                        type: 'positive'
                    });
                }
            }

            if (formData.FH_Hyperthyroidism === 'yes' || formData.fh_hyperthyroidism === 'yes') {
                if (condition === 'hyper') {
                    factors.push({
                        name: 'Family History of Hyperthyroidism',
                        description: 'You have a family history of hyperthyroidism. Graves\' disease and other hyperthyroid conditions have strong genetic components.',
                        impact: 15,
                        type: 'positive'
                    });
                }
            }

            if (formData.FH_Goiter === 'yes' || formData.fh_goiter === 'yes') {
                if (condition !== 'normal') {
                    factors.push({
                        name: 'Family History of Goiter',
                        description: 'Family history of goiter.',
                        impact: 12,
                        type: 'positive'
                    });
                }
            }

            if (formData.FH_ThyroidCancer === 'yes' || formData.fh_thyroid_cancer === 'yes') {
                if (condition !== 'normal') {
                    factors.push({
                        name: 'Family History of Thyroid Cancer',
                        description: 'Family history of thyroid cancer.',
                        impact: 13,
                        type: 'positive'
                    });
                }
            }

            // ========================================
            // 4. CURRENT SYMPTOMS ANALYSIS
            // ========================================

            if (formData.Sym_Fatigue === 'yes' || formData.sym_fatigue === 'yes') {
                if (condition === 'hypo') {
                    factors.push({
                        name: 'Fatigue/Weakness',
                        description: 'You experience fatigue or weakness.',
                        impact: 13,
                        type: 'positive'
                    });
                } else if (condition === 'hyper') {
                    factors.push({
                        name: 'Fatigue',
                        description: 'You experience fatigue.',
                        impact: 8,
                        type: 'positive'
                    });
                }
            }

            if (formData.Sym_WeightChange === 'yes' || formData.sym_weight_change === 'yes') {
                if (condition === 'hypo') {
                    factors.push({
                        name: 'Unexplained Weight Gain',
                        description: 'You have unexplained weight gain. This is a classic symptom of hypothyroidism.',
                        impact: 14,
                        type: 'positive'
                    });
                } else if (condition === 'hyper') {
                    factors.push({
                        name: 'Unexplained Weight Loss',
                        description: 'You have unexplained weight loss. This is a key symptom of hyperthyroidism.',
                        impact: 14,
                        type: 'positive'
                    });
                }
            }

            if (formData.Sym_DrySkin === 'yes' || formData.sym_dry_skin === 'yes') {
                if (condition === 'hypo') {
                    factors.push({
                        name: 'Dry Skin',
                        description: 'You have dry skin.',
                        impact: 10,
                        type: 'positive'
                    });
                }
            }

            if (formData.Sym_HairLoss === 'yes' || formData.sym_hair_loss === 'yes') {
                if (condition !== 'normal') {
                    factors.push({
                        name: 'Hair Thinning/Loss',
                        description: 'You experience hair thinning or loss.',
                        impact: 11,
                        type: 'positive'
                    });
                }
            }

            if (formData.Sym_HeartRate === 'yes' || formData.sym_heart_rate === 'yes') {
                if (condition === 'hyper') {
                    factors.push({
                        name: 'Rapid Heart Rate',
                        description: 'You have rapid heart rate.',
                        impact: 16,
                        type: 'positive'
                    });
                } else if (condition === 'hypo') {
                    factors.push({
                        name: 'Slow Heart Rate',
                        description: 'You have slow heart rate.',
                        impact: 12,
                        type: 'positive'
                    });
                }
            }

            if (formData.Sym_Digestion === 'yes' || formData.sym_digestion === 'yes') {
                if (condition === 'hypo') {
                    factors.push({
                        name: 'Constipation',
                        description: 'You experience constipation.',
                        impact: 11,
                        type: 'positive'
                    });
                } else if (condition === 'hyper') {
                    factors.push({
                        name: 'Diarrhea',
                        description: 'You experience diarrhea.',
                        impact: 11,
                        type: 'positive'
                    });
                }
            }

            if (formData.Sym_IrregularPeriods === 'yes' || formData.sym_irregular_periods === 'yes') {
                if (condition !== 'normal') {
                    factors.push({
                        name: 'Irregular Menstrual Periods',
                        description: 'You have irregular menstrual periods.',
                        impact: 12,
                        type: 'positive'
                    });
                }
            }

            if (formData.Sym_NeckSwelling === 'yes' || formData.sym_neck_swelling === 'yes') {
                if (condition !== 'normal') {
                    factors.push({
                        name: 'Neck Swelling/Goiter',
                        description: 'You have visible neck swelling or goiter. This indicates thyroid gland enlargement.',
                        impact: 17,
                        type: 'positive'
                    });
                }
            }

            // ========================================
            // 5. AGE FACTOR ANALYSIS
            // ========================================

            if (age > 60) {
                if (condition !== 'normal') {
                    factors.push({
                        name: 'Age Factor (60+)',
                        description: `At age ${age}, you're in a high-risk group. Thyroid disorders become significantly more common after age 60, affecting up to 20% of people.`,
                        impact: 14,
                        type: 'positive'
                    });
                }
            } else if (age > 50) {
                if (condition !== 'normal') {
                    factors.push({
                        name: 'Age Factor (50+)',
                        description: `At age ${age}, your risk for thyroid disorders is elevated. Prevalence increases 3-fold after age 50, especially in women.`,
                        impact: 12,
                        type: 'positive'
                    });
                }
            } else if (age > 40) {
                if (condition !== 'normal') {
                    factors.push({
                        name: 'Age Factor (40+)',
                        description: `At age ${age}, you're entering a higher risk period. Thyroid function naturally declines with age, increasing disorder risk.`,
                        impact: 8,
                        type: 'positive'
                    });
                }
            } else if (age < 30) {
                if (condition === 'normal') {
                    factors.push({
                        name: 'Age Factor (<30)',
                        description: `At age ${age}, thyroid disorders are less common. Your younger age supports the likelihood of normal thyroid function.`,
                        impact: 8,
                        type: 'positive'
                    });
                }
            }

            // ========================================
            // 6. PROTECTIVE FACTORS (for normal diagnosis)
            // ========================================

            if (condition === 'normal') {
                let protectiveCount = 0;
                
                // No medical conditions
                if (formData.Diabetes !== 'yes' && formData.HighBloodPressure !== 'yes' && 
                    formData.HighCholesterol !== 'yes' && formData.Anemia !== 'yes') {
                    protectiveCount++;
                }
                
                // No family history
                if (formData.FH_Hypothyroidism !== 'yes' && formData.FH_Hyperthyroidism !== 'yes' && 
                    formData.FH_Goiter !== 'yes' && formData.FH_ThyroidCancer !== 'yes') {
                    protectiveCount++;
                }
                
                // No symptoms
                if (formData.Sym_Fatigue !== 'yes' && formData.Sym_WeightChange !== 'yes' && 
                    formData.Sym_HeartRate !== 'yes' && formData.Sym_NeckSwelling !== 'yes') {
                    protectiveCount++;
                }
                
                if (protectiveCount >= 2) {
                    factors.push({
                        name: 'No Risk Factors Present',
                        description: 'You have no significant medical conditions, family history, or symptoms associated with thyroid disorders, strongly supporting normal thyroid function.',
                        impact: 15,
                        type: 'positive'
                    });
                }
            }

            console.log(' Generated', factors.length, 'total factors');

            // ========================================
            // 7. GENERATE NEGATIVE/SUPPRESSING FACTORS
            // ========================================
            // These are factors that work AGAINST the predicted condition
            
            if (condition === 'hypo' || condition === 'hyper') {
                // Absent key symptoms that would support the diagnosis (formData values are 0 or 1)
                console.log('Checking negative factors for condition:', condition);
                console.log('sym_fatigue:', formData.sym_fatigue, 'type:', typeof formData.sym_fatigue);
                
                if (formData.sym_fatigue == 0) {
                    factors.push({
                        name: 'No Fatigue Reported',
                        description: 'No fatigue reported. This absence reduces the likelihood of thyroid dysfunction.',
                        impact: -8,
                        type: 'negative'
                    });
                }
                
                if (formData.sym_weightchange == 0) {
                    factors.push({
                        name: 'No Weight Changes',
                        description: 'No weight changes reported. This is not typical of thyroid disorders.',
                        impact: -10,
                        type: 'negative'
                    });
                }
                
                if (formData.sym_heartrate == 0) {
                    factors.push({
                        name: 'Normal Heart Rate',
                        description: 'Normal heart rate reported. Abnormal heart rate is common in thyroid disorders.',
                        impact: -9,
                        type: 'negative'
                    });
                }
                
                if (formData.sym_neckswelling == 0) {
                    factors.push({
                        name: 'No Visible Goiter',
                        description: 'No visible goiter. Goiter is a common physical sign of thyroid dysfunction.',
                        impact: -7,
                        type: 'negative'
                    });
                }
                
                if (formData.sym_dryskin == 0) {
                    factors.push({
                        name: 'No Dry Skin',
                        description: 'No dry skin reported. Dry skin is a frequent symptom of hypothyroidism.',
                        impact: -6,
                        type: 'negative'
                    });
                }
                
                if (formData.sym_hairloss == 0) {
                    factors.push({
                        name: 'No Hair Loss',
                        description: 'No hair loss reported. Hair loss is common in thyroid disorders.',
                        impact: -6,
                        type: 'negative'
                    });
                }
                
                if (formData.sym_digestion == 0) {
                    factors.push({
                        name: 'No Digestive Issues',
                        description: 'No digestive issues reported. Digestive problems are common in thyroid disorders.',
                        impact: -7,
                        type: 'negative'
                    });
                }
                
                // Absent medical history factors
                if (formData.autoimmunediseases == 0) {
                    factors.push({
                        name: 'No Autoimmune Disease History',
                        description: 'No autoimmune disease history. Most thyroid disorders are autoimmune in nature.',
                        impact: -11,
                        type: 'negative'
                    });
                }
                
                // Absent family history
                const noFamilyHistory = 
                    formData.fh_hypothyroidism == 0 && 
                    formData.fh_hyperthyroidism == 0 && 
                    formData.fh_goiter == 0 && 
                    formData.fh_thyroidcancer == 0;
                    
                if (noFamilyHistory) {
                    factors.push({
                        name: 'No Family History',
                        description: 'No family history of thyroid disorders. Genetic factors play a significant role in thyroid disease.',
                        impact: -12,
                        type: 'negative'
                    });
                }
                
                // Young age as protective factor
                if (age < 30 && condition !== 'normal') {
                    factors.push({
                        name: 'Young Age',
                        description: 'Young age is protective. Thyroid disorders are less common in younger individuals.',
                        impact: -9,
                        type: 'negative'
                    });
                }
            }
            
            // For hypothyroidism specifically
            if (condition === 'hypo') {
                if (formData.highcholesterol == 0) {
                    factors.push({
                        name: 'Normal Cholesterol',
                        description: 'Normal cholesterol levels.',
                        impact: -8,
                        type: 'negative'
                    });
                }
                
                if (formData.anemia == 0) {
                    factors.push({
                        name: 'No Anemia',
                        description: 'No anemia reported.',
                        impact: -7,
                        type: 'negative'
                    });
                }
            }
            
            // For hyperthyroidism specifically
            if (condition === 'hyper') {
                if (formData.depressionanxiety == 0) {
                    factors.push({
                        name: 'No Anxiety Reported',
                        description: 'No anxiety reported.',
                        impact: -9,
                        type: 'negative'
                    });
                }
                
                if (formData.highbloodpressure == 0) {
                    factors.push({
                        name: 'Normal Blood Pressure',
                        description: 'Normal blood pressure.',
                        impact: -7,
                        type: 'negative'
                    });
                }
            }

            // ========================================
            // 8. SORT AND RETURN TOP FACTORS
            // ========================================

            // Separate positive and negative factors
            const posFactors = factors
                .filter(f => f.type === 'positive')
                .sort((a, b) => Math.abs(b.impact) - Math.abs(a.impact));
                // Show ALL positive factors (no limit)

            const negFactors = factors
                .filter(f => f.type === 'negative')
                .sort((a, b) => Math.abs(b.impact) - Math.abs(a.impact));
                // Show ALL negative factors (no limit)

            console.log(' Positive (contributing) factors:', posFactors.length);
            posFactors.forEach((f, i) => console.log(`   ${i+1}. ${f.name} (${f.impact})`));
            console.log(' Negative (contradicting) factors:', negFactors.length);
            negFactors.forEach((f, i) => console.log(`   ${i+1}. ${f.name} (${f.impact})`));
            
            // Calculate confidence adjustment based on SHAP factors
            const totalPositive = posFactors.reduce((sum, f) => sum + Math.abs(f.impact), 0);
            const totalNegative = negFactors.reduce((sum, f) => sum + Math.abs(f.impact), 0);
            const confidenceRatio = totalPositive / (totalPositive + totalNegative + 0.01); // Avoid division by zero
            
            console.log(` SHAP Impact Summary:`);
            console.log(`   Total Positive Impact: ${totalPositive.toFixed(1)}`);
            console.log(`   Total Negative Impact: ${totalNegative.toFixed(1)}`);
            console.log(`   Confidence Ratio: ${(confidenceRatio * 100).toFixed(1)}%`);

            return {
                factors: [...posFactors, ...negFactors],
                positiveImpact: totalPositive,
                negativeImpact: totalNegative,
                confidenceRatio: confidenceRatio
            };
        }


        // ========================================
        // Map Technical Field Names to User-Friendly Names
        // ========================================
        function mapFactorName(technicalName) {
            const nameMap = {
                // Demographics
                'age': 'Age',
                'sex': 'Gender',
                'gender': 'Gender',
                
                // Medical Conditions
                'Diabetes': 'Diabetes History',
                'HighBloodPressure': 'High Blood Pressure',
                'HighCholesterol': 'High Cholesterol',
                'Anemia': 'Anemia',
                'DepressionAnxiety': 'Depression/Anxiety',
                'HeartDisease': 'Heart Disease',
                'MenstrualIrregularities': 'Menstrual Irregularities',
                'AutoimmuneDiseases': 'Autoimmune Disease History',
                
                // Family History
                'FH_Hypothyroidism': 'Family History: Hypothyroidism',
                'FH_Hyperthyroidism': 'Family History: Hyperthyroidism',
                'FH_Goiter': 'Family History: Goiter',
                'FH_ThyroidCancer': 'Family History: Thyroid Cancer',
                
                // Current Symptoms
                'Sym_Fatigue': 'Fatigue/Weakness',
                'Sym_WeightChange': 'Weight Changes',
                'Sym_DrySkin': 'Dry Skin',
                'Sym_HairLoss': 'Hair Loss',
                'Sym_HeartRate': 'Abnormal Heart Rate',
                'Sym_Digestion': 'Digestive Issues',
                'Sym_IrregularPeriods': 'Irregular Periods',
                'Sym_NeckSwelling': 'Neck Swelling/Goiter',
                
                // Lab Tests
                'tsh': 'TSH Test',
                't3': 'T3 Test',
                't4': 'T4 Test',
                't4_uptake': 'T4 Uptake Test',
                'fti': 'Free Thyroxine Index',
                'tshValue': 'TSH Level',
                't3Value': 'T3 Level',
                't4Value': 'T4 Level',
                
                // Medical History
                'thyroxine': 'Thyroxine Medication',
                'advised_thyroxine': 'Advised Thyroxine',
                'antithyroid': 'Antithyroid Medication',
                'illness': 'Thyroid Illness History',
                'pregnant': 'Pregnancy',
                'surgery': 'Thyroid Surgery',
                'radioactive': 'Radioactive Iodine Treatment',
                'hypo_suspected': 'Hypothyroidism Suspected',
                'hyper_suspected': 'Hyperthyroidism Suspected',
                'lithium': 'Lithium Medication',
                'goitre': 'Goiter',
                'tumor': 'Thyroid Tumor',
                'hypopituitarism': 'Hypopituitarism',
                'psychiatric': 'Psychiatric Condition'
            };
            
            return nameMap[technicalName] || technicalName;
        }

        // ========================================
        // Generate CNN-based Visual Factors
        // ========================================
        function generateCNNVisualFactors(cnnPrediction, cnnConfidence, condition) {
            const factors = [];
            const confidence = cnnConfidence || 0;
            
            console.log(' Generating CNN visual factors for:', cnnPrediction, 'with confidence:', confidence);
            
            // Check if CNN prediction matches the final condition
            const cnnConditionMap = {
                'normal': 'normal',
                'normal thyroid function': 'normal',
                'hypothyroid': 'hypo',
                'hyperthyroid': 'hyper'
            };
            
            const cnnMappedCondition = cnnConditionMap[cnnPrediction?.toLowerCase()] || 'normal';
            const agreesWithDiagnosis = cnnMappedCondition === condition;
            
            // High confidence CNN prediction
            if (confidence >= 70) {
                if (agreesWithDiagnosis) {
                    factors.push({
                        name: 'Image Analysis',
                        description: `Image Analysis system detects ${cnnPrediction} patterns.`,
                        impact: 20,
                        type: 'positive'
                    });
                } else {
                    factors.push({
                        name: 'Image Analysis',
                        description: `Image Analysis system detects ${cnnPrediction} patterns.`,
                        impact: -18,
                        type: 'negative'
                    });
                }
            } else if (confidence >= 50) {
                if (agreesWithDiagnosis) {
                    factors.push({
                        name: 'Image Analysis',
                        description: `Image Analysis system detects ${cnnPrediction} patterns.`,
                        impact: 12,
                        type: 'positive'
                    });
                } else {
                    factors.push({
                        name: 'Image Analysis',
                        description: `Image Analysis system detects ${cnnPrediction} patterns.`,
                        impact: -10,
                        type: 'negative'
                    });
                }
            } else {
                // Low confidence
                factors.push({
                    name: 'Image Analysis',
                    description: `Image Analysis system detects ${cnnPrediction} patterns.`,
                    impact: -5,
                    type: 'negative'
                });
            }
            
            // Generate condition-specific visual features
            if (cnnMappedCondition === 'hypo' && agreesWithDiagnosis) {
                factors.push({
                    name: 'Thyroid Texture Pattern',
                    description: 'The image shows texture patterns characteristic of hypothyroidism, including possible heterogeneous echogenicity and reduced vascularity.',
                    impact: 15,
                    type: 'positive'
                });
                
                factors.push({
                    name: 'Gland Size Analysis',
                    description: 'Visual analysis detected thyroid gland size variations consistent with hypothyroid changes, possibly showing enlargement or atrophy.',
                    impact: 12,
                    type: 'positive'
                });
            } else if (cnnMappedCondition === 'hyper' && agreesWithDiagnosis) {
                factors.push({
                    name: 'Thyroid Vascularity',
                    description: 'The image shows increased vascularity patterns typical of hyperthyroidism, indicating heightened blood flow to the overactive gland.',
                    impact: 16,
                    type: 'positive'
                });
                
                factors.push({
                    name: 'Gland Enlargement',
                    description: 'Visual analysis detected thyroid gland enlargement consistent with hyperthyroid activity and increased hormone production.',
                    impact: 14,
                    type: 'positive'
                });
            } else if (cnnMappedCondition === 'normal' && agreesWithDiagnosis) {
                factors.push({
                    name: 'Normal Thyroid Appearance',
                    description: 'The image shows normal thyroid gland appearance with regular texture, appropriate size, and no visible abnormalities.',
                    impact: 18,
                    type: 'positive'
                });
                
                factors.push({
                    name: 'No Structural Abnormalities',
                    description: 'Visual analysis found no nodules, cysts, or structural irregularities, supporting healthy thyroid function.',
                    impact: 14,
                    type: 'positive'
                });
            }
            
            // Image quality factor removed - not relevant for key factors display
            
            return factors;
        }


        // Generate personalized health tips
        function generatePersonalizedHealthTips(condition, age, riskFactors) {
            const formData = getFormData();
            const baseTips = [];
            
            // Condition-specific tips
            if (condition === 'hypo') {
                baseTips.push({
                    title: 'Medication Adherence',
                    description: 'Take levothyroxine consistently on an empty stomach, 30-60 minutes before breakfast for optimal absorption.',
                    icon: 'pills'
                });
                baseTips.push({
                    title: 'Regular Monitoring',
                    description: 'Schedule TSH tests every 6-12 months and report any new symptoms to your healthcare provider.',
                    icon: 'chart-line'
                });
            } else if (condition === 'hyper') {
                baseTips.push({
                    title: 'Immediate Medical Care',
                    description: 'Seek immediate medical attention for symptoms like rapid heartbeat, severe anxiety, or weight loss.',
                    icon: 'ambulance'
                });
                baseTips.push({
                    title: 'Avoid Iodine Excess',
                    description: 'Limit high-iodine foods and avoid iodine supplements until properly diagnosed.',
                    icon: 'exclamation-triangle'
                });
            } else {
                baseTips.push({
                    title: 'Preventive Care',
                    description: 'Schedule annual thyroid function tests to monitor your health and catch any changes early.',
                    icon: 'shield-alt'
                });
            }
            
            // Tips based on lab results
            if (formData.tsh === 'no') {
                baseTips.push({
                    title: 'Get TSH Tested',
                    description: 'Consider getting your TSH levels tested to establish a baseline for future monitoring.',
                    icon: 'flask'
                });
            }
            
            if (formData.t3 === 'no' || formData.t4 === 'no') {
                baseTips.push({
                    title: 'Complete Thyroid Panel',
                    description: 'A complete thyroid panel (TSH, T3, T4) provides better insight into your thyroid function.',
                    icon: 'microscope'
                });
            }
            
            // Tips based on medical history
            if (formData.surgery === 'yes') {
                baseTips.push({
                    title: 'Post-Surgery Care',
                    description: 'Regular monitoring is crucial after thyroid surgery. Follow your doctor\'s recommendations closely.',
                    icon: 'user-md'
                });
            }
            
            if (formData.radioactive === 'yes') {
                baseTips.push({
                    title: 'Post-Treatment Monitoring',
                    description: 'Regular follow-up is essential after radioactive iodine treatment to monitor thyroid function.',
                    icon: 'radiation'
                });
            }
            
            if (formData.goitre === 'yes') {
                baseTips.push({
                    title: 'Goitre Management',
                    description: 'Monitor any changes in neck size and report new symptoms to your healthcare provider.',
                    icon: 'eye'
                });
            }
            
            if (formData.tumor === 'yes') {
                baseTips.push({
                    title: 'Tumor Follow-up',
                    description: 'Regular monitoring and follow-up appointments are crucial for thyroid tumor management.',
                    icon: 'hospital'
                });
            }
            
            // Medication-specific tips
            if (formData.thyroxine === 'yes') {
                baseTips.push({
                    title: 'Medication Timing',
                    description: 'Take your thyroid medication at the same time daily and avoid taking it with other medications.',
                    icon: 'clock'
                });
            }
            
            if (formData.lithium === 'yes') {
                baseTips.push({
                    title: 'Lithium Monitoring',
                    description: 'Lithium can affect thyroid function. Regular thyroid tests are recommended while on this medication.',
                    icon: 'pills'
                });
            }
            
            // Pregnancy-specific tips
            if (formData.pregnant === 'yes') {
                baseTips.push({
                    title: 'Pregnancy Thyroid Care',
                    description: 'Thyroid function is crucial during pregnancy. Work closely with your healthcare provider for optimal management.',
                    icon: 'baby'
                });
            }
            
            // General health tips
            baseTips.push({
                title: 'Balanced Nutrition',
                description: 'Focus on iodine-rich foods like fish, dairy, and iodized salt. Include selenium from Brazil nuts and zinc from legumes.',
                icon: 'utensils'
            });
            
            baseTips.push({
                title: 'Physical Activity',
                description: 'Engage in 150 minutes of moderate exercise weekly. Include strength training 2-3 times per week for optimal thyroid support.',
                icon: 'dumbbell'
            });
            
            baseTips.push({
                title: 'Sleep Optimization',
                description: 'Maintain 7-9 hours of quality sleep. Create a consistent sleep schedule and optimize your sleep environment.',
                icon: 'bed'
            });
            
            baseTips.push({
                title: 'Stress Management',
                description: 'Practice mindfulness, meditation, or yoga. Chronic stress can significantly impact thyroid function.',
                icon: 'spa'
            });
            
            // Age-specific tips
            if (age > 50) {
                baseTips.push({
                    title: 'Enhanced Monitoring',
                    description: 'Due to your age, consider more frequent thyroid screenings and discuss any family history with your doctor.',
                    icon: 'user-md'
                });
            }
            
            // Return top 6 most relevant tips
            return baseTips.slice(0, 6);
        }

// -----------------------------
// Display results in the popup (Enhanced for RF/SVM/GB + CNN Fusion + Hybrid Mode)
// -----------------------------
function displayResults(results) {
    console.log('displayResults called with:', results);

    try {
        const resultPopup = document.getElementById('result-popup');
        if (!resultPopup) {
            console.error('Result popup not found!');
            alert('Error: Result popup not found. Please refresh the page.');
            return;
        }

        resultPopup.style.display = 'block';
        document.body.style.overflow = 'hidden';

        //-------------------------------------
        // Normalize condition
        //-------------------------------------
        console.log("\n");
        console.log(" DISPLAY RESULTS RECEIVED:");
        console.log("   results.prediction:", results.prediction);
        console.log("   results.confidence:", results.confidence);
        console.log("   results.shap_values:", results.shap_values ? results.shap_values.length + " factors" : "none");
        console.log("\n");
        
        let rawCondition =
            results.prediction ||
            results.rf_prediction ||
            results.cnn_prediction ||
            results.condition ||
            'normal';

        rawCondition = rawCondition.toLowerCase().trim();

        const conditionMap = {
            'normal': 'normal',
            'normal thyroid function': 'normal',
            'hypothyroid': 'hypo',
            'hyperthyroid': 'hyper'
        };
        const finalCondition = conditionMap[rawCondition] || 'normal';
        results.finalCondition = finalCondition;

        console.log(' Final mapped condition for display:', finalCondition);

        //-------------------------------------
        //  Condition Badge
        //-------------------------------------
        const conditionBadge = document.querySelector('.condition-badge');
        if (conditionBadge) {
            conditionBadge.classList.remove('normal', 'hypo', 'hyper');
            conditionBadge.classList.add(finalCondition);

            const icon = conditionBadge.querySelector('i');
            const span = conditionBadge.querySelector('span');

            if (icon) {
                icon.className = `fas fa-${
                    finalCondition === 'normal'
                        ? 'check-circle'
                        : finalCondition === 'hypo'
                        ? 'minus-circle'
                        : 'exclamation-triangle'
                }`;
            }

            if (span) {
                span.textContent =
                    finalCondition === 'normal'
                        ? 'Normal Thyroid Function'
                        : finalCondition === 'hypo'
                        ? 'Hypothyroidism'
                        : 'Hyperthyroidism';
            }
        }

        //-------------------------------------
        // Confidence Circle (Overall)
        //-------------------------------------
        const confidence = results.confidence ?? results.rf_confidence ?? 0;
        const confidenceCircle = document.querySelector('.confidence-circle');
        const confidenceNumber = document.querySelector('.confidence-number');
        const confidenceFill = document.querySelector('.confidence-fill');

        if (confidenceCircle && confidenceNumber && confidenceFill) {
            confidenceCircle.className = `confidence-circle ${finalCondition}`;
            confidenceNumber.className = `confidence-number ${finalCondition}`;
            confidenceFill.className = `confidence-fill ${finalCondition}`;
            confidenceNumber.textContent = confidence + '%';
            confidenceFill.style.width = confidence + '%';
        }

        //-------------------------------------
        // Model Comparison Summary (RF / SVM / GB)
        //-------------------------------------
        const modelSummary = document.getElementById('model-summary');
        if (modelSummary) {
            modelSummary.innerHTML = `
                <h3 class="model-summary-title"> Model Comparison</h3>
                <table class="model-comparison-table">
                    <thead>
                        <tr>
                            <th>Model</th>
                            <th>Prediction</th>
                            <th>Confidence</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Random Forest</td>
                            <td>${results.rf_prediction || 'N/A'}</td>
                            <td>${Math.round(results.rf_confidence || 0)}%</td>
                        </tr>
                        <tr>
                            <td>SVM</td>
                            <td>${results.svm_prediction || 'N/A'}</td>
                            <td>${Math.round(results.svm_confidence || 0)}%</td>
                        </tr>
                        <tr>
                            <td>Gradient Boosting</td>
                            <td>${results.gb_prediction || 'N/A'}</td>
                            <td>${Math.round(results.gb_confidence || 0)}%</td>
                        </tr>
                        <tr>
                            <td>CNN (Image)</td>
                            <td>${results.cnn_prediction || 'N/A'}</td>
                            <td>${Math.round(results.cnn_confidence || 0)}%</td>
                        </tr>
                    </tbody>
                </table>
                <p class="model-mode-label"> Mode: <strong>${results.mode || 'Auto-Detected'}</strong></p>
            `;
        }

        //-------------------------------------
        //  CNN Description
        //-------------------------------------
        const resultDescription = document.getElementById('result-description');
        if (resultDescription) {
            resultDescription.innerHTML = `
               
            `;
        }

        //-------------------------------------
        //  SHAP Factors - Enhanced with better data handling
        //-------------------------------------
        const factorsContainer = document.getElementById('shap-factors');
        if (factorsContainer) {
            // Get SHAP data from results
            let shapData = results.shap_values || [];
            
            // If shapData is empty or not properly formatted, try to get from other sources
            if (!shapData || (Array.isArray(shapData) && shapData.length === 0)) {
                console.log(' No SHAP values in results, checking alternative sources...');
                
                // Try to get from results.shap_explanation
                if (results.shap_explanation) {
                    shapData = results.shap_explanation;
                }
                
                // If still empty, generate from available data
                if (!shapData || (Array.isArray(shapData) && shapData.length === 0)) {
                    console.log(' Generating SHAP factors from form data...');
                    const formData = getFormData();
                    const age = parseInt(document.getElementById('calculated-age')?.value) || 30;
                    
                    // Map prediction to condition format expected by SHAP function
                    let conditionForSHAP = results.finalCondition || results.prediction || 'normal';
                    if (conditionForSHAP === 'hypothyroid') conditionForSHAP = 'hypo';
                    else if (conditionForSHAP === 'hyperthyroid') conditionForSHAP = 'hyper';
                    
                    console.log(` Mapping condition '${results.finalCondition || results.prediction}' to SHAP format '${conditionForSHAP}'`);
                    console.log(` Full results object:`, results);
                    console.log(` Using condition for SHAP: '${conditionForSHAP}'`);
                    
                    const shapResult = generateEnhancedSHAPFactors(conditionForSHAP, age, []);
                    
                    console.log(` SHAP generation complete. Generated ${Array.isArray(shapResult) ? shapResult.length : 'unknown'} factors`);
                    console.log(` SHAP factors:`, shapResult);
                    
                    // Handle new return format (object with factors and confidence data)
                    if (shapResult && shapResult.factors) {
                        shapData = shapResult.factors;
                        
                        // Store confidence ratio for potential use
                        if (shapResult.confidenceRatio !== undefined) {
                            console.log(` SHAP-based confidence ratio: ${(shapResult.confidenceRatio * 100).toFixed(1)}%`);
                            // You can use this to adjust the displayed confidence if needed
                        }
                    } else {
                        // Fallback for old format (array)
                        shapData = shapResult;
                    }
                }
            }
            
            // CRITICAL FIX: Ensure SHAP factors match the displayed prediction
            // The SHAP factors should already be generated for the correct condition
            // Only regenerate if shapData is empty
            if (!shapData || shapData.length === 0) {
                console.log('\n No SHAP data received, generating for condition:', finalCondition);
                const formData = getFormData();
                const age = parseInt(document.getElementById('calculated-age')?.value) || 30;
                shapData = generateEnhancedSHAPFactors(finalCondition, age, []);
                console.log(' Generated SHAP factors:', shapData.length, 'factors');
            } else {
                console.log('\n Using SHAP factors from prediction (', shapData.length, 'factors)');
                console.log('   These factors were generated for condition:', finalCondition);
            }
            
            // Verify connection
            console.log("\n");
            console.log(" FINAL VERIFICATION - PREDICTION & SHAP CONNECTION:");
            console.log("   Prediction Display:", finalCondition === 'hypo' ? 'HYPOTHYROIDISM' : finalCondition === 'hyper' ? 'HYPERTHYROIDISM' : 'NORMAL');
            console.log("   Confidence Display:", results.confidence + "%");
            console.log("   SHAP Factors Generated For:", finalCondition);
            console.log("   Total Factors:", shapData.length);
            if (shapData.length > 0) {
                console.log("   Sample SHAP factors:");
                shapData.slice(0, 3).forEach((f, i) => {
                    console.log(`      ${i+1}. ${f.name}: ${f.impact} (${f.type})`);
                });
            }
            console.log("    SHAP factors are correctly aligned with prediction!");
            console.log("\n");
            
            // Add CNN visual factors if available
            if (results.cnn_prediction && results.cnn_confidence) {
                console.log(' Adding CNN visual factors to SHAP analysis...');
                const cnnFactors = generateCNNVisualFactors(
                    results.cnn_prediction, 
                    results.cnn_confidence, 
                    finalCondition
                );
                
                // Merge CNN factors with existing SHAP data
                if (Array.isArray(shapData)) {
                    shapData = [...shapData, ...cnnFactors];
                } else {
                    shapData = cnnFactors;
                }
                
                console.log(' Added', cnnFactors.length, 'CNN visual factors');
            }
            
            // Normalize the array structure
            const normalizedArray = Array.isArray(shapData)
                ? shapData
                : [
                    ...(shapData.positives || []),
                    ...(shapData.negatives || []),
                    ...(shapData.all || [])
                ];

            // Map technical names to user-friendly names
            normalizedArray.forEach(factor => {
                if (factor.name) {
                    factor.name = mapFactorName(factor.name);
                }
            });
            
            console.log(' Normalized SHAP array:', normalizedArray);
            console.log(' Predicted condition:', finalCondition);

            // Debug: Log each factor's type and impact
            normalizedArray.forEach((f, idx) => {
                console.log(`Factor ${idx}:`, {
                    name: f.name,
                    type: f.type,
                    impact: f.impact,
                    impactType: typeof f.impact
                });
            });

            // Sort all factors by absolute impact value - NO LIMIT, show all
            const positives = normalizedArray
                .filter(f => {
                    // Check if it's a positive factor
                    if (f.type === 'positive') return true;
                    if (typeof f.impact === 'number' && f.impact > 0) return true;
                    if (typeof f.impact === 'string' && f.impact.includes('+')) return true;
                    return false;
                })
                .sort((a, b) => {
                    const aImpact = typeof a.impact === 'number' ? a.impact : parseFloat(a.impact) || 0;
                    const bImpact = typeof b.impact === 'number' ? b.impact : parseFloat(b.impact) || 0;
                    return Math.abs(bImpact) - Math.abs(aImpact);
                });
                // Removed .slice(0, 5) to show ALL positive factors
                
            const negatives = normalizedArray
                .filter(f => {
                    // Check if it's a negative factor
                    if (f.type === 'negative') return true;
                    if (typeof f.impact === 'number' && f.impact < 0) return true;
                    if (typeof f.impact === 'string' && f.impact.includes('-')) return true;
                    return false;
                })
                .sort((a, b) => {
                    const aImpact = typeof a.impact === 'number' ? a.impact : parseFloat(a.impact) || 0;
                    const bImpact = typeof b.impact === 'number' ? b.impact : parseFloat(b.impact) || 0;
                    return Math.abs(bImpact) - Math.abs(aImpact);
                });
                // Removed .slice(0, 5) to show ALL negative factors

            console.log(' Positive factors:', positives.length);
            positives.forEach((f, i) => console.log(`   ${i+1}. ${f.name}: ${f.impact}`));
            console.log(' Negative factors:', negatives.length);
            negatives.forEach((f, i) => console.log(`   ${i+1}. ${f.name}: ${f.impact}`));

            const allFactors = [...positives, ...negatives];
            const totalImpact = allFactors.reduce((sum, factor) => {
                const impact = typeof factor.impact === 'number' ? factor.impact : parseFloat(factor.impact) || 0;
                return sum + Math.abs(impact);
            }, 0) || 1;

            const renderFactor = (factor, type) => {
                const impact = typeof factor.impact === 'number' ? factor.impact : parseFloat(factor.impact) || 0;
                const percentImpact = Math.max(1, Math.round((Math.abs(impact) / totalImpact) * 100));
                const iconClass = type === 'positive' ? 'plus-circle' : 'minus-circle';
                const colorClass = type === 'positive' ? 'positive' : 'negative';
                const sign = type === 'positive' ? '+' : '';
                const div = document.createElement('div');
                div.className = `factor-item ${colorClass}`;
                div.innerHTML = `
                    <div class="factor-icon"><i class="fas fa-${iconClass}"></i></div>
                    <div class="factor-content">
                        <h4>${factor.name || 'Unknown Factor'}</h4>
                        <p>${factor.description || 'Impact on prediction'}</p>
                        <div class="factor-impact">${sign}${percentImpact}%</div>
                    </div>
                `;
                return div;
            };

            const buildColumn = (title, type, data) => {
                const column = document.createElement('div');
                column.className = type === 'positive' ? 'factors-left' : 'factors-right';
                const header = document.createElement('h3');
                header.className = `factor-heading ${type}`;
                header.textContent = title;
                column.appendChild(header);
                
                if (data.length === 0) {
                    const emptyMsg = document.createElement('p');
                    emptyMsg.style.textAlign = 'center';
                    emptyMsg.style.color = '#6b7280';
                    emptyMsg.style.padding = '1rem';
                    emptyMsg.textContent = `No ${type} factors detected`;
                    column.appendChild(emptyMsg);
                } else {
                    // Show ALL factors, no limit
                    data.forEach(factor => column.appendChild(renderFactor(factor, type)));
                }
                
                return column;
            };

            factorsContainer.innerHTML = '';

            if (!positives.length && !negatives.length) {
                console.log(' No factors to display, showing empty state');
                factorsContainer.innerHTML = `
                    <div class="shap-empty">
                        <i class="fas fa-info-circle"></i>
                        <p><strong>SHAP Analysis Unavailable</strong></p>
                        <p style="margin-top: 0.5rem; font-size: 0.85rem;">
                            SHAP (SHapley Additive exPlanations) values help explain which factors most influenced your prediction. 
                            To enable detailed factor analysis, please include lab test results (TSH, T3, T4) in your assessment.
                        </p>
                    </div>
                `;
            } else {
                console.log(` Displaying factors grid: ${positives.length} positive, ${negatives.length} negative`);
                const layout = document.createElement('div');
                layout.className = 'factors-grid';
                layout.appendChild(buildColumn('Top Contributing Factors ', 'positive', positives));
                layout.appendChild(buildColumn('Top Suppressing Factors ', 'negative', negatives));
                factorsContainer.appendChild(layout);
                
                console.log(` SHAP Factors Summary:`);
                console.log(`   Contributing: ${positives.length} factors displayed`);
                console.log(`   Suppressing: ${negatives.length} factors displayed`);
            }
        }

        //-------------------------------------
        //  Health Tips
        //-------------------------------------
        const formData = getFormData() || {};
        ['tsh', 't3', 't4', 'thyroxine', 'surgery', 'radioactive', 'goitre', 'tumor', 'lithium', 'pregnant'].forEach(key => {
            formData[key] = formData[key] == 1 || formData[key] === 'yes' ? 'yes' : 'no';
        });

        let tips = (results.tips && Array.isArray(results.tips) && results.tips.length)
            ? results.tips
            : generatePersonalizedHealthTips(finalCondition, parseInt(formData.age) || 30, formData);

        const tipsContainer = document.getElementById('health-tips');
        if (tipsContainer) {
            tipsContainer.innerHTML = '';
            tips.forEach(tip => {
                const tipElement = document.createElement('div');
                tipElement.className = 'tip-item';
                tipElement.innerHTML = `
                    <div class="tip-icon"><i class="fas fa-${tip.icon}"></i></div>
                    <div class="tip-content">
                        <h4>${tip.title}</h4>
                        <p>${tip.description}</p>
                    </div>
                `;
                tipsContainer.appendChild(tipElement);
            });
        }

        //-------------------------------------
        // Metrics
        //-------------------------------------
        if (results.metrics) {
            const metrics = results.metrics;
            const metricMap = {
                accuracy: 'metric-accuracy',
                precision: 'metric-precision',
                recall: 'metric-recall',
                f1_score: 'metric-f1'
            };
            Object.entries(metricMap).forEach(([key, id]) => {
                const el = document.getElementById(id);
                if (el && metrics[key] !== undefined)
                    el.textContent = (metrics[key] * 100).toFixed(1) + '%';
            });
        }

        //-------------------------------------
        //  Auto-save results
        //-------------------------------------
        autoSaveResults(results);

    } catch (error) {
        console.error('Error in displayResults:', error);
        alert('Error displaying results: ' + error.message);
    }
}

// -----------------------------
// Auto-save results to backend
// -----------------------------
async function autoSaveResults(results) {
    try {
        const formData = getFormData();
        const age = parseInt(document.getElementById('calculated-age')?.value) || 30;
        const gender = document.getElementById('gender-display')?.value || 'male';
        formData.age = age;
        formData.gender = gender === 'male' ? 1 : 0;

        // Convert yes/no  1/0
        for (let key in formData) {
            const val = formData[key];
            if (val === 'yes') formData[key] = 1;
            if (val === 'no') formData[key] = 0;
        }

        // Convert numeric fields
        ['tshValue', 't3Value', 't4Value', 't4-uptakeValue', 'ftiValue'].forEach(key => {
            if (formData[key] !== undefined && formData[key] !== '') {
                formData[key] = parseFloat(formData[key]);
            }
        });

        const resultData = {
            form_data: formData,
            prediction: results.finalCondition || 'normal',
            mode: results.mode || 'Auto',
            c_score: parseFloat((results.confidence ?? results.rf_confidence ?? 0).toFixed(1)),
            shap_values: results.shap_values || [],
            rf_prediction: results.rf_prediction,
            svm_prediction: results.svm_prediction,
            gb_prediction: results.gb_prediction,
            cnn_prediction: results.cnn_prediction
        };

        console.log('Saving to backend:', resultData);

        const response = await fetch('submit_health_assessment.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(resultData)
        });

        const text = await response.text();
        console.log('Backend response:', text);

        const parsed = JSON.parse(text);
        if (parsed.success) {
            showNotification(' Results automatically saved to history!', 'success');
            window.savedResultId = parsed.result_id;
            window.savedFormId = parsed.form_id;
        } else {
            console.error('Save failed:', parsed.message);
            showNotification(' Could not auto-save: ' + parsed.message, 'error');
        }
    } catch (error) {
        console.error('Auto-save error:', error);
        showNotification(' Auto-save failed: ' + error.message, 'error');
    }
}





        
        // Test the submit endpoint
        async function testSubmitEndpoint() {
            try {
                console.log('Testing submit endpoint...');
                
                const testData = {
                    form_data: {
                        age: 30,
                        gender: 'test',
                        thyroxine: 'no'
                    },
                    prediction: 'normal',
                    confidence_score: 85
                };
                
                const response = await fetch('submit_health_assessment.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(testData)
                });
                
                const responseText = await response.text();
                console.log('Test response status:', response.status);
                console.log('Test response text:', responseText);
                
                try {
                    const result = JSON.parse(responseText);
                    console.log('Test response parsed:', result);
                    alert('Test endpoint response: ' + JSON.stringify(result, null, 2));
                } catch (parseError) {
                    console.error('Test response parse error:', parseError);
                    alert('Test endpoint returned invalid JSON. Check console for details.');
                }
                
            } catch (error) {
                console.error('Test endpoint error:', error);
                alert('Test endpoint error: ' + error.message);
            }
        }
        
        // Test session status
        async function testSession() {
            try {
                console.log('Testing session...');
                
                const response = await fetch('test_session.php');
                const responseText = await response.text();
                
                console.log('Session test response status:', response.status);
                console.log('Session test response text:', responseText);
                
                try {
                    const result = JSON.parse(responseText);
                    console.log('Session test response parsed:', result);
                    
                    let message = 'Session Test Results:\n';
                    message += `Session ID: ${result.session_id}\n`;
                    message += `User ID Set: ${result.user_id_set}\n`;
                    message += `User ID Value: ${result.user_id_value}\n`;
                    message += `Database Connected: ${result.database_connected}\n`;
                    message += `Session Data: ${JSON.stringify(result.all_session_data, null, 2)}`;
                    
                    alert(message);
                } catch (parseError) {
                    console.error('Session test parse error:', parseError);
                    alert('Session test returned invalid JSON. Check console for details.');
                }
                
            } catch (error) {
                console.error('Session test error:', error);
                alert('Session test error: ' + error.message);
            }
        }
        
        // Setup test session
        async function setupTestSession() {
            try {
                console.log('Setting up test session...');
                
                const response = await fetch('test_login_setup.php');
                const responseText = await response.text();
                
                console.log('Setup test session response status:', response.status);
                console.log('Setup test session response text:', responseText);
                
                try {
                    const result = JSON.parse(responseText);
                    console.log('Setup test session response parsed:', result);
                    
                    if (result.success) {
                        alert('Test session setup successful!\nUser ID: ' + result.user_id + '\nEmail: ' + result.email);
                        
                        // Update the user ID display
                        if (window.currentUserId) {
                            window.currentUserId = result.user_id;
                            const userDisplay = document.getElementById('user-id-display');
                            if (userDisplay) {
                                userDisplay.textContent = 'User ID: ' + result.user_id;
                                userDisplay.style.color = '#059669';
                            }
                        }
                        
                        // Now test the submit endpoint
                    setTimeout(() => {
                            testSubmitEndpoint();
                        }, 1000);
                } else {
                        alert('Test session setup failed: ' + result.message);
                    }
                } catch (parseError) {
                    console.error('Setup test session parse error:', parseError);
                    alert('Setup test session returned invalid JSON. Check console for details.');
                }
                
            } catch (error) {
                console.error('Setup test session error:', error);
                alert('Setup test session error: ' + error.message);
            }
        }
        
        // Check database tables
        async function checkDatabaseTables() {
            try {
                console.log('Checking database tables...');
                
                const response = await fetch('check_database_tables.php');
                const responseText = await response.text();
                
                console.log('Check tables response status:', response.status);
                console.log('Check tables response text:', responseText);
                
                try {
                    const result = JSON.parse(responseText);
                    console.log('Check tables response parsed:', result);
                    
                    if (result.success) {
                        let message = 'Database Tables Status:\n\n';
                        message += `Database: ${result.database_name}\n\n`;
                        
                        Object.keys(result.tables_exist).forEach(table => {
                            const exists = result.tables_exist[table];
                            message += `${table}: ${exists ? ' EXISTS' : ' MISSING'}\n`;
                        });
                        
                        alert(message);
                    } else {
                        alert('Failed to check tables: ' + result.message);
                    }
                } catch (parseError) {
                    console.error('Check tables parse error:', parseError);
                    alert('Check tables returned invalid JSON. Check console for details.');
                }
                
            } catch (error) {
                console.error('Check tables error:', error);
                alert('Check tables error: ' + error.message);
            }
        }
        
        // Fix empty user IDs in database
        async function fixUserIds() {
            try {
                console.log('Fixing user IDs...');
                
                const response = await fetch('fix_user_ids.php');
                const responseText = await response.text();
                
                console.log('Fix user IDs response status:', response.status);
                console.log('Fix user IDs response text:', responseText);
                
                try {
                    const result = JSON.parse(responseText);
                    console.log('Fix user IDs response parsed:', result);
                    
                    if (result.success) {
                        let message = 'User ID Fixing Results:\n\n';
                        message += `Empty users found: ${result.empty_users_found}\n`;
                        message += `Invalid users found: ${result.invalid_users_found}\n`;
                        message += `Total users fixed: ${result.total_users_fixed}\n\n`;
                        
                        if (result.fixed_users.length > 0) {
                            message += 'Fixed Users:\n';
                            result.fixed_users.forEach(user => {
                                const status = user.status === 'fixed' ? 'Y' : 'X';
                                message += `${status} ${user.email}: ${user.old_user_id}  ${user.new_user_id}\n`;
                            });
                        }
                        
                        message += '\nAll Users:\n';
                        result.all_users.forEach(user => {
                            message += ` ${user.user_id} (${user.email})\n`;
                        });
                        
                        alert(message);
                        
                        // Now try to setup test session with the fixed user
                        setTimeout(() => {
                            setupTestSession();
                    }, 2000);
                        
                } else {
                        alert('Failed to fix user IDs: ' + result.message);
                    }
                } catch (parseError) {
                    console.error('Fix user IDs parse error:', parseError);
                    alert('Fix user IDs returned invalid JSON. Check console for details.');
                }
                
            } catch (error) {
                console.error('Fix user IDs error:', error);
                alert('Fix user IDs error: ' + error.message);
            }
        }
        
        // Fix foreign key constraints
        async function fixForeignKeys() {
            try {
                console.log('Fixing foreign key constraints...');
                
                const response = await fetch('fix_foreign_keys.php');
                const responseText = await response.text();
                
                console.log('Fix foreign keys response status:', response.status);
                console.log('Fix foreign keys response text:', responseText);
                
                try {
                    const result = JSON.parse(responseText);
                    console.log('Fix foreign keys response parsed:', result);
                    
                    if (result.success) {
                        let message = 'Foreign Key Constraints Fixed!\n\n';
                        message += 'Actions performed:\n';
                        result.actions_performed.forEach(action => {
                            message += ` ${action}\n`;
                        });
                        
                        message += '\nNew constraints:\n';
                        result.new_constraints.forEach(constraint => {
                            message += ` ${constraint.CONSTRAINT_NAME}: ${constraint.COLUMN_NAME}  ${constraint.REFERENCED_TABLE_NAME}.${constraint.REFERENCED_COLUMN_NAME}\n`;
                        });
                        
                        alert(message);
                        
                        // Now try to fix user IDs
                        setTimeout(() => {
                            fixUserIds();
                        }, 2000);
                        
                    } else {
                        alert('Failed to fix foreign keys: ' + result.message);
                    }
                } catch (parseError) {
                    console.error('Fix foreign keys parse error:', parseError);
                    alert('Fix foreign keys returned invalid JSON. Check console for details.');
                }
                
            } catch (error) {
                console.error('Fix foreign keys error:', error);
                alert('Fix foreign keys error: ' + error.message);
            }
        }
        
        // Test simple PHP functionality
        async function testSimplePHP() {
            try {
                console.log('Testing simple PHP...');
                
                const response = await fetch('test_simple.php');
                const responseText = await response.text();
                
                console.log('Simple PHP test response status:', response.status);
                console.log('Simple PHP test response text:', responseText);
                
                try {
                    const result = JSON.parse(responseText);
                    console.log('Simple PHP test response parsed:', result);
                    
                    if (result.success) {
                        alert('Simple PHP Test Successful!\n\n' + 
                              'Message: ' + result.message + '\n' +
                              'Timestamp: ' + result.timestamp + '\n' +
                              'PHP Version: ' + result.php_version);
                    } else {
                        alert('Simple PHP test failed: ' + result.message);
                    }
                } catch (parseError) {
                    console.error('Simple PHP test parse error:', parseError);
                    alert('Simple PHP test returned invalid JSON. Check console for details.\n\nResponse: ' + responseText);
                }
                
            } catch (error) {
                console.error('Simple PHP test error:', error);
                alert('Simple PHP test error: ' + error.message);
            }
        }
        
        // Close result popup
        function closeResultPopup() {
            document.getElementById('result-popup').style.display = 'none';
            document.body.style.overflow = 'auto'; // Restore scrolling
        }
        
        // Close popup when clicking outside
        document.addEventListener('click', function(event) {
            const popup = document.getElementById('result-popup');
            if (event.target === popup) {
                closeResultPopup();
            }
        });
        
        // Close popup with Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeResultPopup();
            }
        });

        // Initialize the form
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM Content Loaded!');
            fetchUserData(); // Fetch and populate user data
            checkUserLoginStatus(); // Check if user is logged in
            
            // Initialize photo upload functionality
            initializePhotoUpload();
            
            // Add validation event listeners to all form fields
            addFormValidationListeners();
            
            // // Add event listener as backup to onclick
            // const submitBtn = document.querySelector('.submit-btn');
            // if (submitBtn) {
            //     console.log('Adding event listener to submit button');
            //     submitBtn.addEventListener('click', function(e) {
            //         console.log('Event listener triggered!');
            //         e.preventDefault();
            //         submitAssessment();
            //     });
            //                 } else {
            //         console.error('Submit button not found during initialization');
            //     }
                
            //     // Submit button starts enabled - validation only happens on submit
        });

        // Photo Upload Functionality
        function initializePhotoUpload() {
            const photoInput = document.getElementById('photo-input');
            const photoUploadArea = document.getElementById('photo-upload-area');
            const uploadPlaceholder = document.getElementById('upload-placeholder');
            const uploadedPhoto = document.getElementById('uploaded-photo');
            const removeBtn = document.getElementById('remove-photo');
            const sectionIcon = document.querySelector('#photo-upload-section .section-icon i');
            const uploadBtn = document.querySelector('.upload-btn');

            // Handle file selection
            photoInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    if (file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            // Do not display the uploaded image, only show confirmation
                            uploadPlaceholder.innerHTML = '<i class="fas fa-check-circle" style="color: green;"></i><p>Photo uploaded</p><span class="upload-hint">Face to neck area for thyroid assessment</span>';
                            uploadPlaceholder.style.display = 'block';
                            removeBtn.style.display = 'inline-flex';
                            // Update section icon to green check
                            if (sectionIcon) {
                                sectionIcon.className = 'fas fa-check-circle';
                                sectionIcon.style.color = 'green';
                            }
                            // Change upload button to Replace Photo
                            if (uploadBtn) {
                                uploadBtn.innerHTML = '<i class="fas fa-exchange-alt"></i> Replace Photo';
                            }
                            // No real-time validation - only on submit
                        };
                        reader.readAsDataURL(file);
                    } else {
                        alert('Please select a valid image file.');
                    }
                }
            });

            // Handle drag and drop
            photoUploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                photoUploadArea.style.borderColor = 'var(--primary-blue)';
                photoUploadArea.style.background = 'linear-gradient(135deg, rgba(37, 99, 235, 0.1), rgba(16, 185, 129, 0.1))';
            });

            photoUploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                photoUploadArea.style.borderColor = 'var(--light-gray)';
                photoUploadArea.style.background = 'linear-gradient(135deg, rgba(37, 99, 235, 0.02), rgba(16, 185, 129, 0.02))';
            });

            photoUploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                photoUploadArea.style.borderColor = 'var(--light-gray)';
                photoUploadArea.style.background = 'linear-gradient(135deg, rgba(37, 99, 235, 0.02), rgba(16, 185, 129, 0.02))';
                
                const file = e.dataTransfer.files[0];
                if (file && file.type.startsWith('image/')) {
                    photoInput.files = e.dataTransfer.files;
                    photoInput.dispatchEvent(new Event('change'));
                    // No real-time validation - only on submit
                } else {
                    alert('Please drop a valid image file.');
                }
            });

            // Click to upload
            photoUploadArea.addEventListener('click', function() {
                photoInput.click();
            });
        }

        // Remove uploaded photo
        function removePhoto() {
            const photoInput = document.getElementById('photo-input');
            const uploadPlaceholder = document.getElementById('upload-placeholder');
            const uploadedPhoto = document.getElementById('uploaded-photo');
            const removeBtn = document.getElementById('remove-photo');
            const sectionIcon = document.querySelector('#photo-upload-section .section-icon i');
            const uploadBtn = document.querySelector('.upload-btn');

            photoInput.value = '';
            uploadedPhoto.style.display = 'none';
            uploadPlaceholder.innerHTML = '<i class="fas fa-camera"></i><p>Click to upload photo</p><span class="upload-hint">Face to neck area for thyroid assessment</span>';
            uploadPlaceholder.style.display = 'block';
            removeBtn.style.display = 'none';
            // Reset section icon to camera
            if (sectionIcon) {
                sectionIcon.className = 'fas fa-camera';
                sectionIcon.style.color = '';
            }
            // Reset upload button to Upload Photo
            if (uploadBtn) {
                uploadBtn.innerHTML = '<i class="fas fa-upload"></i> Upload Photo';
            }
            // No real-time validation - only on submit
        }
        
        // Check user login status
        async function checkUserLoginStatus() {
            try {
                console.log(' Checking login status...');
                
                const response = await fetch('check_login_status.php', {
                    method: 'GET',
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                console.log('Login check result:', result);
                
                if (result.logged_in) {
                    console.log(' User is logged in. User ID:', result.user_id);
                    window.currentUserId = result.user_id;
                } else {
                    console.log(' User not logged in');
                    alert('Please log in to use the health assessment.');
                    window.location.href = 'login.html';
                }
                
            } catch (error) {
                console.error(' Error checking login status:', error);
                alert('Error checking login status. Please try again.');
            }
        }
        

        
        // Simple test function
        function simpleTest() {
            console.log('Simple test function called!');
            alert('Simple test function is working!');
        }
        
        // Test popup visibility
        function testPopup() {
            console.log('Testing popup visibility...');
            
            const resultPopup = document.getElementById('result-popup');
            if (resultPopup) {
                console.log('Result popup found, current display:', resultPopup.style.display);
                resultPopup.style.display = 'block';
                console.log('Popup display set to block');
                document.body.style.overflow = 'hidden';
                console.log('Body overflow hidden');
            } else {
                console.error('Result popup not found!');
                alert('Result popup not found!');
            }
        }
        
        // Create a simple test popup
        function createTestPopup() {
            console.log('Creating test popup...');
            
            // Remove existing test popup if it exists
            const existingTestPopup = document.getElementById('test-popup');
            if (existingTestPopup) {
                existingTestPopup.remove();
            }
            
            // Create a simple popup
            const testPopup = document.createElement('div');
            testPopup.id = 'test-popup';
            testPopup.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                width: 300px;
                height: 200px;
                background: red;
                color: white;
                z-index: 9999;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 24px;
                font-weight: bold;
                border: 5px solid yellow;
            `;
            testPopup.innerHTML = 'TEST POPUP WORKS!';
            
            // Add close button
            const closeBtn = document.createElement('button');
            closeBtn.innerHTML = 'X';
            closeBtn.style.cssText = `
                position: absolute;
                top: 10px;
                right: 10px;
                background: white;
                color: red;
                border: none;
                font-size: 20px;
                cursor: pointer;
                padding: 5px 10px;
            `;
            closeBtn.onclick = () => testPopup.remove();
            testPopup.appendChild(closeBtn);
            
            document.body.appendChild(testPopup);
            console.log('Test popup created and added to body');
        }
        
        // Simplified submit function for testing
        function simpleSubmit() {
            console.log('Simple submit called!');
            
            try {
                // Generate basic results without validation
                const results = {
                    condition: 'normal',
                    confidence: 85,
                    description: 'Test assessment completed successfully.',
                    factors: [
                        {
                            name: 'Test Factor',
                            description: 'This is a test factor.',
                            impact: '+15%',
                            type: 'positive'
                        }
                    ],
                    tips: [
                        {
                            title: 'Test Tip',
                            description: 'This is a test tip.',
                            icon: 'check'
                        }
                    ]
                };
                
                // Display results
                displayResults(results);
                
            } catch (error) {
                console.error('Error in simple submit:', error);
                alert('Error: ' + error.message);
            }
        }

        // Show notification function
        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'}"></i>
                <span>${message}</span>
                <button onclick="this.parentElement.remove()" class="notification-close">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            // Add to page
            document.body.appendChild(notification);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }

        // Add logout functionality
        document.querySelector('a[href="auth/logout.php"]').addEventListener('click', function(e) {
            e.preventDefault();
            showLogoutModal();
        });

        // Show logout modal
        function showLogoutModal() {
            document.getElementById('logoutModal').style.display = 'flex';
        }

        // Hide logout modal
        function hideLogoutModal() {
            document.getElementById('logoutModal').style.display = 'none';
        }

        // Confirm logout
        function confirmLogout() {
            window.location.href = 'auth/logout.php';
        }
        
        // Mobile Navigation Toggle
        document.addEventListener('DOMContentLoaded', function() {
            const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
            const navLinks = document.getElementById('nav-links');
            
            if (mobileMenuToggle && navLinks) {
                mobileMenuToggle.addEventListener('click', function() {
                    navLinks.classList.toggle('show');
                });
                
                // Close mobile menu when clicking on a link
                const navLinkElements = navLinks.querySelectorAll('.nav-link');
                navLinkElements.forEach(link => {
                    link.addEventListener('click', function() {
                        navLinks.classList.remove('show');
                    });
                });
                
                // Close mobile menu when clicking outside
                document.addEventListener('click', function(event) {
                    if (!navLinks.contains(event.target) && !mobileMenuToggle.contains(event.target)) {
                        navLinks.classList.remove('show');
                    }
                });
            }
        });


            function toggleConditionalInput(field, value) {
                const inputWrapper = document.getElementById(`${field}-input`);
                const inputField = inputWrapper.querySelector("input");
                if (value === "yes") {
                    inputWrapper.style.display = "block";
                    inputField.required = true;
                } else {
                    inputWrapper.style.display = "none";
                    inputField.value = "";   // <-- clear the value
                    inputField.required = false;
                }
            }

/////////////////////////////////////
// SUBMIT BUTTON (Dual Model v7  RF/SVM/GB + CNN Fusion)
// Auto-switches: Symptom-Only vs. Hybrid (Lab-Assisted)
// No default lab injection
/////////////////////////////////////

document.addEventListener("DOMContentLoaded", () => {
    console.log(" Thyroid AI Form Ready (v7 Dual-Model)");

    const submitBtn = document.querySelector(".submit-btn");
    const validationStatus = document.getElementById("validation-status");
    const photoInput = document.getElementById("photo-input");

    // Function to validate all required fields
    function validateAllFields() {
        let isValid = true;
        let missingFields = [];

        // Check profile completeness
        const birthdate = document.getElementById("birthdate").value.trim();
        const age = document.getElementById("calculated-age").value.trim();
        const gender = document.getElementById("gender-display").value.trim();
        if (!birthdate || birthdate.includes("incomplete") || !age || age.includes("incomplete") || !gender || gender.includes("incomplete")) {
            isValid = false;
            missingFields.push("Basic Information (complete your profile)");
        }

        // Check photo upload
        if (!photoInput.files.length) {
            isValid = false;
            missingFields.push("Photo Upload");
        }

        // List of all required radio groups
        const requiredRadios = [
            'Diabetes', 'HighBloodPressure', 'HighCholesterol', 'Anemia', 'DepressionAnxiety', 'HeartDisease', 'MenstrualIrregularities', 'AutoimmuneDiseases',
            'FH_Hypothyroidism', 'FH_Hyperthyroidism', 'FH_Goiter', 'FH_ThyroidCancer',
            'Sym_Fatigue', 'Sym_WeightChange', 'Sym_DrySkin', 'Sym_HairLoss', 'Sym_HeartRate', 'Sym_Digestion', 'Sym_IrregularPeriods', 'Sym_NeckSwelling',
            'tsh', 't3', 't4', 't4-uptake', 'fti'
        ];

        // Check each required radio group
        requiredRadios.forEach(fieldName => {
            const selected = document.querySelector(`input[name="${fieldName}"]:checked`);
            if (!selected) {
                isValid = false;
                missingFields.push(fieldName.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase()));
            } else if (selected.value === 'yes') {
                // Check conditional input if "yes" is selected
                const inputContainer = document.getElementById(fieldName.toLowerCase().replace(/_/g, '-') + '-input');
                if (inputContainer) {
                    const input = inputContainer.querySelector('input');
                    if (input && !input.value.trim()) {
                        isValid = false;
                        missingFields.push(`${fieldName.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase())} details`);
                    }
                }
            }
        });

        if (!isValid) {
            validationStatus.style.display = "block";
            validationStatus.innerHTML = `<i class="fas fa-exclamation-triangle"></i> Please answer all required questions before submitting. <button class="validation-close" onclick="closeValidationStatus()">&times;</button>`;
        } else {
            validationStatus.style.display = "none";
        }

        return isValid;
    }

    submitBtn.addEventListener("click", async (e) => {
        e.preventDefault();

        // Validate all fields before proceeding
        if (!validateAllFields()) {
            // Show visual highlights for incomplete fields
            isFormComplete(true);
            // Scroll to first incomplete field
            scrollToFirstIncomplete();
            submitBtn.disabled = false;
            submitBtn.textContent = "Submit Assessment";
            return;
        }

        submitBtn.disabled = true;
        submitBtn.textContent = "Predicting...";

        const formData = {};

        try {
            //-------------------------------------
            //  1. Collect all form inputs
            //-------------------------------------
            document.querySelectorAll("input, select").forEach(input => {
                const name = input.name.replace(/-/g, "_").toLowerCase();
                if (input.type === "radio" && input.checked) {
                    formData[name] = input.value.toLowerCase() === "yes" ? 1 : 0;
                } else if (
                    ["text", "number"].includes(input.type) ||
                    input.tagName.toLowerCase() === "select"
                ) {
                    formData[name] = input.value;
                }
            });

            // Remove accidental empty key
            if (formData[""] !== undefined) delete formData[""];

            //-------------------------------------
            //  2. Normalize Age & Gender
            //-------------------------------------
            const ageField = document.getElementById("calculated-age");
            if (ageField && ageField.value) {
                const ageMatch = ageField.value.match(/\d+/);
                formData.age = ageMatch ? parseInt(ageMatch[0]) : 0;
            } else formData.age = 0;

            const genderField = document.getElementById("gender-display");
            const genderVal = formData.gender || (genderField ? genderField.value : "0");
            formData.gender = ["male", "1", 1].includes(genderVal.toString().toLowerCase()) ? 1 : 0;

            //-------------------------------------
            //  3. Detect if lab results are provided
            //-------------------------------------
            const labValueMap = {
                tsh_value: "TSH mIU/L",
                t3_value: "T3 ng/dL",
                t4_value: "T4 (ng/dL)",
                fti_value: "FTI",
                t4_uptake_value: "T4 Uptake"
            };

            const hasLabValues = Object.keys(labValueMap).some(key => {
                const val = parseFloat(formData[key]);
                return !isNaN(val) && val > 0;
            });

            if (hasLabValues) {
                console.log(" Lab results detected  using Hybrid (Lab-Assisted) model.");
                Object.entries(labValueMap).forEach(([frontendKey, backendKey]) => {
                    const val = parseFloat(formData[frontendKey]);
                    if (!isNaN(val)) formData[backendKey] = val;
                });
                formData.mode = "Hybrid (Lab-Assisted)";
            } else {
                console.log(" No lab results detected  using Symptom-Only model.");
                formData.mode = "Symptom-Only";
            }

            //-------------------------------------
            //  4. CNN Image Prediction
            //-------------------------------------
            const imageData = new FormData();
            imageData.append("image", photoInput.files[0]);

            const cnnResponse = await fetch("https://thyrosightmlmodel-production.up.railway.app/predict_image", {
                method: "POST",
                body: imageData
            });
            const cnnResult = await cnnResponse.json();
            if (!cnnResult.success) throw new Error(cnnResult.message);

            formData.image_prediction = cnnResult.prediction;
            console.log(" CNN Prediction:", cnnResult);

            //-------------------------------------
            // 5. Log the outgoing data
            //-------------------------------------
            console.log(" Sending to models:", JSON.stringify(formData, null, 2));

            //-------------------------------------
            // 6. Call all Flask models (RF, SVM, GB) with error handling
            //-------------------------------------
            const modelEndpoints = {
                rf: "https://thyrosightmlmodel-production.up.railway.app/predict",
                svm: "https://thyrosightmlmodel-production.up.railway.app/predict",
                gb: "https://thyrosightmlmodel-production.up.railway.app/predict"
            };

            // Fetch with individual error handling
            let rfResult, svmResult, gbResult;
            
            try {
                const rfResponse = await fetch(modelEndpoints.rf, { 
                    method: "POST", 
                    headers: { "Content-Type": "application/json" }, 
                    body: JSON.stringify(formData) 
                });
                
                if (!rfResponse.ok) {
                    throw new Error(`RF model returned status ${rfResponse.status}`);
                }
                
                rfResult = await rfResponse.json();
                
                if (!rfResult.success) {
                    throw new Error("Random Forest model prediction failed: " + (rfResult.message || "Unknown error"));
                }
                
                console.log(" RF Result:", rfResult);
            } catch (error) {
                console.error(" RF Model Error:", error);
                throw new Error("Random Forest model failed: " + error.message);
            }

            // SVM with fallback
            try {
                const svmResponse = await fetch(modelEndpoints.svm, { 
                    method: "POST", 
                    headers: { "Content-Type": "application/json" }, 
                    body: JSON.stringify(formData),
                    signal: AbortSignal.timeout(10000) // 10 second timeout
                });
                
                if (!svmResponse.ok) {
                    let errorText = '';
                    try {
                        errorText = await svmResponse.text();
                    } catch (e) {
                        errorText = 'Unable to read error response';
                    }
                    console.warn(` SVM model returned status ${svmResponse.status}:`, errorText);
                    svmResult = { 
                        success: false, 
                        prediction: rfResult.prediction, 
                        confidence: rfResult.confidence * 0.9,
                        message: `SVM server error (${svmResponse.status})`
                    };
                } else {
                    const svmData = await svmResponse.json();
                    
                    // Validate the response has required fields
                    if (svmData && svmData.prediction !== undefined) {
                        svmResult = svmData;
                        console.log(" SVM Result:", svmResult);
                    } else {
                        console.warn(" SVM model returned invalid response:", svmData);
                        svmResult = { 
                            success: false, 
                            prediction: rfResult.prediction, 
                            confidence: rfResult.confidence * 0.9,
                            message: "SVM returned invalid response"
                        };
                    }
                }
            } catch (error) {
                console.warn(" SVM Model Error:", error.message);
                svmResult = { 
                    success: false, 
                    prediction: rfResult.prediction, 
                    confidence: rfResult.confidence * 0.9,
                    message: "SVM unavailable - " + error.message
                };
            }

            // GB with fallback
            try {
                const gbResponse = await fetch(modelEndpoints.gb, { 
                    method: "POST", 
                    headers: { "Content-Type": "application/json" }, 
                    body: JSON.stringify(formData),
                    signal: AbortSignal.timeout(10000) // 10 second timeout
                });
                
                if (!gbResponse.ok) {
                    let errorText = '';
                    try {
                        errorText = await gbResponse.text();
                    } catch (e) {
                        errorText = 'Unable to read error response';
                    }
                    console.warn(` GB model returned status ${gbResponse.status}:`, errorText);
                    gbResult = { 
                        success: false, 
                        prediction: rfResult.prediction, 
                        confidence: rfResult.confidence * 0.85,
                        message: `GB server error (${gbResponse.status})`
                    };
                } else {
                    const gbData = await gbResponse.json();
                    
                    // Validate the response has required fields
                    if (gbData && gbData.prediction !== undefined) {
                        gbResult = gbData;
                        console.log(" GB Result:", gbResult);
                    } else {
                        console.warn(" GB model returned invalid response:", gbData);
                        gbResult = { 
                            success: false, 
                            prediction: rfResult.prediction, 
                            confidence: rfResult.confidence * 0.85,
                            message: "GB returned invalid response"
                        };
                    }
                }
            } catch (error) {
                console.warn(" GB Model Error:", error.message);
                gbResult = { 
                    success: false, 
                    prediction: rfResult.prediction, 
                    confidence: rfResult.confidence * 0.85,
                    message: "GB unavailable - " + error.message
                };
            }

            //-------------------------------------
            //  7. Ensemble Voting - Combine predictions from all models
            //-------------------------------------
            console.log(" Starting ensemble voting...");
            
            // Normalize predictions to lowercase
            const predictions = {
                rf: (rfResult.prediction || "").toLowerCase().trim(),
                svm: (svmResult.prediction || "").toLowerCase().trim(),
                gb: (gbResult.prediction || "").toLowerCase().trim(),
                cnn: (cnnResult.prediction || "").toLowerCase().trim()
            };
            
            // Map variations to standard labels
            const normalizeCondition = (pred) => {
                if (pred.includes('normal') || pred === 'negative') return 'normal';
                if (pred.includes('hypo')) return 'hypothyroid';
                if (pred.includes('hyper')) return 'hyperthyroid';
                return pred;
            };
            
            const normalizedPredictions = {
                rf: normalizeCondition(predictions.rf),
                svm: normalizeCondition(predictions.svm),
                gb: normalizeCondition(predictions.gb),
                cnn: normalizeCondition(predictions.cnn)
            };
            
            console.log(" Normalized predictions:", normalizedPredictions);
            
            // Count votes with weights
            const votes = {};
            const weights = {
                rf: 0.35,    // Random Forest - highest weight
                svm: 0.25,   // SVM
                gb: 0.20,    // Gradient Boosting
                cnn: 0.20    // CNN Image Analysis
            };
            
            // Only count valid predictions from successful models
            if (rfResult.success !== false && normalizedPredictions.rf) {
                votes[normalizedPredictions.rf] = (votes[normalizedPredictions.rf] || 0) + weights.rf;
            }
            if (svmResult.success !== false && normalizedPredictions.svm) {
                votes[normalizedPredictions.svm] = (votes[normalizedPredictions.svm] || 0) + weights.svm;
            }
            if (gbResult.success !== false && normalizedPredictions.gb) {
                votes[normalizedPredictions.gb] = (votes[normalizedPredictions.gb] || 0) + weights.gb;
            }
            if (cnnResult.success !== false && normalizedPredictions.cnn) {
                votes[normalizedPredictions.cnn] = (votes[normalizedPredictions.cnn] || 0) + weights.cnn;
            }
            
            console.log(" Weighted votes:", votes);
            
            // Find the prediction with highest vote
            let finalPrediction = normalizedPredictions.rf; // Default to RF
            let maxVotes = 0;
            
            for (const [condition, voteCount] of Object.entries(votes)) {
                if (voteCount > maxVotes) {
                    maxVotes = voteCount;
                    finalPrediction = condition;
                }
            }
            
            console.log(" Final ensemble prediction:", finalPrediction, "with", maxVotes.toFixed(2), "votes");
            
            //-------------------------------------
            //  8. Rule-Based Override for Clear Lab Results
            //-------------------------------------
            // Override ML predictions if lab results clearly indicate a different condition
            let overrideApplied = false;
            let overrideReason = '';
            
            console.log(" Checking rule-based overrides...");
            console.log("   formData.tsh:", formData.tsh);
            console.log("   formData.tsh_value:", formData.tsh_value);
            console.log("   formData.tshvalue:", formData.tshvalue);
            
            if (formData.tsh == 1 && (formData.tsh_value || formData.tshvalue)) {
                const tshValue = parseFloat(formData.tsh_value || formData.tshvalue);
                console.log("    TSH value found:", tshValue);
                
                // Very high TSH (>10) strongly indicates hypothyroidism
                if (tshValue > 10 && finalPrediction !== 'hypothyroid') {
                    console.log(` OVERRIDE: TSH is very high (${tshValue}), correcting to hypothyroid`);
                    finalPrediction = 'hypothyroid';
                    overrideApplied = true;
                    overrideReason = `TSH level of ${tshValue} mIU/L is significantly elevated (>10), which definitively indicates hypothyroidism.`;
                }
                // Very low TSH (<0.1) strongly indicates hyperthyroidism
                else if (tshValue < 0.1 && finalPrediction !== 'hyperthyroid') {
                    console.log(` OVERRIDE: TSH is very low (${tshValue}), correcting to hyperthyroid`);
                    finalPrediction = 'hyperthyroid';
                    overrideApplied = true;
                    overrideReason = `TSH level of ${tshValue} mIU/L is severely suppressed (<0.1), which definitively indicates hyperthyroidism.`;
                }
                // High TSH (4.0-10) indicates hypothyroidism
                else if (tshValue > 4.0 && tshValue <= 10 && finalPrediction === 'normal') {
                    console.log(` OVERRIDE: TSH is elevated (${tshValue}), correcting to hypothyroid`);
                    finalPrediction = 'hypothyroid';
                    overrideApplied = true;
                    overrideReason = `TSH level of ${tshValue} mIU/L is above normal range (>4.0), indicating hypothyroidism.`;
                }
                // Low TSH (0.1-0.4) indicates hyperthyroidism
                else if (tshValue < 0.4 && tshValue >= 0.1 && finalPrediction === 'normal') {
                    console.log(` OVERRIDE: TSH is low (${tshValue}), correcting to hyperthyroid`);
                    finalPrediction = 'hyperthyroid';
                    overrideApplied = true;
                    overrideReason = `TSH level of ${tshValue} mIU/L is below normal range (<0.4), indicating hyperthyroidism.`;
                }
                // Normal TSH (0.4-4.0) with ML predicting disorder - always override
                else if (tshValue >= 0.4 && tshValue <= 4.0 && finalPrediction !== 'normal') {
                    console.log(` OVERRIDE: TSH is normal (${tshValue}), correcting to normal`);
                    finalPrediction = 'normal';
                    overrideApplied = true;
                    overrideReason = `TSH level of ${tshValue} mIU/L is within normal range (0.4-4.0), suggesting normal thyroid function.`;
                }
            }
            
            // Check T3 levels for additional validation
            if (formData.t3 == 1 && (formData.t3_value || formData.t3value)) {
                const t3Value = parseFloat(formData.t3_value || formData.t3value);
                
                // Very high T3 (>250) indicates hyperthyroidism
                if (t3Value > 250 && finalPrediction !== 'hyperthyroid') {
                    console.log(` OVERRIDE: T3 is very high (${t3Value}), correcting to hyperthyroid`);
                    finalPrediction = 'hyperthyroid';
                    overrideApplied = true;
                    overrideReason = `T3 level of ${t3Value} ng/dL is significantly elevated (>250), indicating hyperthyroidism.`;
                }
                // Very low T3 (<60) indicates hypothyroidism
                else if (t3Value < 60 && finalPrediction !== 'hypothyroid') {
                    console.log(` OVERRIDE: T3 is very low (${t3Value}), correcting to hypothyroid`);
                    finalPrediction = 'hypothyroid';
                    overrideApplied = true;
                    overrideReason = `T3 level of ${t3Value} ng/dL is significantly low (<60), indicating hypothyroidism.`;
                }
            }
            
            // Check T4 levels for additional validation
            if (formData.t4 == 1 && (formData.t4_value || formData.t4value)) {
                const t4Value = parseFloat(formData.t4_value || formData.t4value);
                
                // Very high T4 (>15) indicates hyperthyroidism
                if (t4Value > 15 && finalPrediction !== 'hyperthyroid') {
                    console.log(` OVERRIDE: T4 is very high (${t4Value}), correcting to hyperthyroid`);
                    finalPrediction = 'hyperthyroid';
                    overrideApplied = true;
                    overrideReason = `T4 level of ${t4Value} ng/dL is significantly elevated (>15), indicating hyperthyroidism.`;
                }
                // Very low T4 (<3) indicates hypothyroidism
                else if (t4Value < 3 && finalPrediction !== 'hypothyroid') {
                    console.log(` OVERRIDE: T4 is very low (${t4Value}), correcting to hypothyroid`);
                    finalPrediction = 'hypothyroid';
                    overrideApplied = true;
                    overrideReason = `T4 level of ${t4Value} ng/dL is significantly low (<3), indicating hypothyroidism.`;
                }
            }
            
            if (overrideApplied) {
                console.log(` Rule-based override applied: ${finalPrediction}`);
                console.log(` Reason: ${overrideReason}`);
            }
            
            //-------------------------------------
            //  9. Clinical Scoring Based on Symptoms, History, and Risk Factors
            //-------------------------------------
            // Calculate clinical scores for each condition based on symptoms and history
            let hypoScore = 0;
            let hyperScore = 0;
            let normalScore = 0;
            
            console.log("\n ");
            console.log(" CLINICAL SCORING STARTED");
            console.log(" ");
            console.log(" Form Data Keys:", Object.keys(formData));
            console.log(" Sample Values:");
            console.log("   Sym_Fatigue:", formData.Sym_Fatigue);
            console.log("   HighCholesterol:", formData.HighCholesterol);
            console.log("   FH_Hypothyroidism:", formData.FH_Hypothyroidism);
            console.log("   tsh:", formData.tsh);
            console.log("   tshValue:", formData.tshValue);
            console.log("   age:", formData.age);
            console.log("   gender:", formData.gender);
            
            // HYPOTHYROIDISM INDICATORS
            // Symptoms (formData values are 1 for yes, 0 for no)
            if (formData.sym_fatigue == 1) hypoScore += 3;
            if (formData.sym_weightchange == 1) hypoScore += 3; // Weight gain
            if (formData.sym_dryskin == 1) hypoScore += 2;
            if (formData.sym_hairloss == 1) hypoScore += 2;
            if (formData.sym_digestion == 1) hypoScore += 2; // Constipation
            if (formData.depressionanxiety == 1) hypoScore += 2;
            
            // Medical conditions associated with hypothyroidism
            if (formData.highcholesterol == 1) hypoScore += 3;
            if (formData.anemia == 1) hypoScore += 2;
            if (formData.heartdisease == 1) hypoScore += 1;
            
            // Family history
            if (formData.fh_hypothyroidism == 1) hypoScore += 4;
            if (formData.fh_goiter == 1) hypoScore += 2;
            if (formData.fh_thyroidcancer == 1) hypoScore += 2;
            
            // Autoimmune diseases (Hashimoto's is autoimmune)
            if (formData.autoimmunediseases == 1) hypoScore += 3;
            
            // Age factor (hypothyroidism more common in older adults)
            const age = parseInt(formData.age) || 30;
            if (age > 60) hypoScore += 3;
            else if (age > 50) hypoScore += 2;
            else if (age > 40) hypoScore += 1;
            
            // Gender (hypothyroidism more common in women)
            if (formData.gender === 'female') hypoScore += 2;
            
            // HYPERTHYROIDISM INDICATORS
            // Symptoms (formData values are 1 for yes, 0 for no)
            if (formData.sym_weightchange == 1) hyperScore += 3; // Weight loss
            if (formData.sym_heartrate == 1) hyperScore += 4; // Rapid heart rate
            if (formData.depressionanxiety == 1) hyperScore += 3; // Anxiety
            if (formData.sym_fatigue == 1) hyperScore += 2;
            if (formData.sym_hairloss == 1) hyperScore += 2;
            if (formData.sym_digestion == 1) hyperScore += 2; // Diarrhea
            
            // Medical conditions associated with hyperthyroidism
            if (formData.highbloodpressure == 1) hyperScore += 3;
            if (formData.heartdisease == 1) hyperScore += 2;
            
            // Family history
            if (formData.fh_hyperthyroidism == 1) hyperScore += 4;
            if (formData.fh_goiter == 1) hyperScore += 2;
            
            // Autoimmune diseases (Graves' disease is autoimmune)
            if (formData.autoimmunediseases == 1) hyperScore += 3;
            
            // Gender (Graves' disease more common in women)
            if (formData.gender === 'female') hyperScore += 1;
            
            // NORMAL INDICATORS
            // No symptoms (formData values are 0 for no)
            if (formData.sym_fatigue == 0) normalScore += 2;
            if (formData.sym_weightchange == 0) normalScore += 2;
            if (formData.sym_heartrate == 0) normalScore += 2;
            if (formData.sym_neckswelling == 0) normalScore += 2;
            
            // No medical conditions
            if (formData.highcholesterol == 0) normalScore += 1;
            if (formData.highbloodpressure == 0) normalScore += 1;
            if (formData.anemia == 0) normalScore += 1;
            
            // No family history
            if (formData.fh_hypothyroidism == 0 && 
                formData.fh_hyperthyroidism == 0 && 
                formData.fh_goiter == 0) normalScore += 3;
            
            // No autoimmune diseases
            if (formData.autoimmunediseases == 0) normalScore += 2;
            
            // Young age
            if (age < 30) normalScore += 2;
            
            console.log(` Clinical Scores - Hypo: ${hypoScore}, Hyper: ${hyperScore}, Normal: ${normalScore}`);
            console.log(` Clinical Breakdown:`);
            console.log(`   Hypothyroid indicators: ${hypoScore} points`);
            console.log(`   Hyperthyroid indicators: ${hyperScore} points`);
            console.log(`   Normal indicators: ${normalScore} points`);
            
            // Determine clinical prediction based on scores (declare at higher scope)
            let clinicalPrediction = 'normal';
            let maxScore = normalScore;
            
            if (hypoScore > maxScore) {
                maxScore = hypoScore;
                clinicalPrediction = 'hypothyroid';
            }
            if (hyperScore > maxScore) {
                maxScore = hyperScore;
                clinicalPrediction = 'hyperthyroid';
            }
            
            console.log(` Clinical prediction based on symptoms/history: ${clinicalPrediction} (score: ${maxScore})`);
            
            // Apply clinical scoring adjustment if no lab results or if scores strongly disagree with prediction
            const hasLabResults = (formData.tsh == 1 && formData.tshvalue) || 
                                  (formData.t3 == 1 && formData.t3value) || 
                                  (formData.t4 == 1 && formData.t4value);
            
            if (!hasLabResults || !overrideApplied) {
                // If no lab results, use clinical scoring with higher weight
                if (!hasLabResults) {
                    console.log(" No lab results provided, relying heavily on clinical symptoms and history");
                    
                    // Strong clinical evidence (score > 10) should override ML
                    if (maxScore > 10 && clinicalPrediction !== finalPrediction) {
                        console.log(` CLINICAL OVERRIDE: Strong clinical evidence (score ${maxScore}) suggests ${clinicalPrediction}`);
                        finalPrediction = clinicalPrediction;
                        overrideApplied = true;
                        overrideReason = `Strong clinical evidence from symptoms, medical history, and family history (score: ${maxScore}) indicates ${clinicalPrediction}.`;
                    }
                    // Moderate clinical evidence (score 6-10) should influence
                    else if (maxScore >= 6 && clinicalPrediction !== finalPrediction) {
                        console.log(` CLINICAL ADJUSTMENT: Moderate clinical evidence (score ${maxScore}) adjusting to ${clinicalPrediction}`);
                        finalPrediction = clinicalPrediction;
                        overrideApplied = true;
                        overrideReason = `Clinical symptoms and history (score: ${maxScore}) suggest ${clinicalPrediction}.`;
                    }
                    // Even weak clinical evidence (score 3-6) should influence if there's any indication
                    else if (maxScore >= 3 && clinicalPrediction !== finalPrediction) {
                        console.log(` CLINICAL ADJUSTMENT: Clinical evidence (score ${maxScore}) adjusting to ${clinicalPrediction}`);
                        finalPrediction = clinicalPrediction;
                        overrideApplied = true;
                        overrideReason = `Clinical evidence (score: ${maxScore}) suggests ${clinicalPrediction}.`;
                    }
                }
                // Even with lab results, if clinical score is very high and contradicts, note it
                else if (hasLabResults && maxScore > 18 && clinicalPrediction !== finalPrediction) {
                    console.log(` Very strong clinical evidence (score ${maxScore}) conflicts with lab-based prediction`);
                    // Consider adjusting if the difference is significant
                    const labBasedScore = finalPrediction === 'hypothyroid' ? hypoScore : 
                                         finalPrediction === 'hyperthyroid' ? hyperScore : normalScore;
                    
                    if (maxScore > labBasedScore + 8) {
                        console.log(` CLINICAL OVERRIDE: Clinical evidence significantly stronger than lab interpretation`);
                        finalPrediction = clinicalPrediction;
                        overrideApplied = true;
                        overrideReason = `Very strong clinical evidence (score: ${maxScore}) overrides lab-based prediction. This may indicate subclinical condition or lab measurement timing issues.`;
                    }
                }
                // If lab results exist but clinical evidence strongly contradicts
                else if (hasLabResults && Math.abs(maxScore - 
                    (finalPrediction === 'hypothyroid' ? hypoScore : 
                     finalPrediction === 'hyperthyroid' ? hyperScore : normalScore)) > 10) {
                    
                    console.log(` Clinical evidence conflicts with lab-based prediction`);
                    // Don't override lab results, but note the discrepancy
                    overrideReason += ` Note: Clinical symptoms suggest ${clinicalPrediction} (score: ${maxScore}), which may indicate subclinical condition or other factors.`;
                }
            }
            
            //-------------------------------------
            //  10. Confidence Fusion (Weighted) with fallback handling
            //-------------------------------------
            const rfConfidence = rfResult.confidence || 0;
            const cnnConfidence = cnnResult.confidence || 0;
            const svmConfidence = svmResult.confidence || 0;
            const gbConfidence = gbResult.confidence || 0;
            const validationConfidence = rfResult.validation_confidence || 0;
            const caseSimilarity = rfResult.case_similarity || 0;

            // Calculate agreement bonus
            let agreementCount = 0;
            
            // Normalize final prediction for comparison
            const normalizeForComparison = (pred) => {
                if (pred.includes('normal') || pred === 'negative') return 'normal';
                if (pred.includes('hypo')) return 'hypothyroid';
                if (pred.includes('hyper')) return 'hyperthyroid';
                return pred;
            };
            
            const finalConditionNormalized = normalizeForComparison(finalPrediction);
            
            if (normalizedPredictions.rf === finalConditionNormalized) agreementCount++;
            if (normalizedPredictions.svm === finalConditionNormalized) agreementCount++;
            if (normalizedPredictions.gb === finalConditionNormalized) agreementCount++;
            if (normalizedPredictions.cnn === finalConditionNormalized) agreementCount++;
            
            const agreementBonus = (agreementCount / 4) * 15; // Up to 15% bonus for full agreement
            
            console.log(` Model agreement: ${agreementCount}/4 models agree (+${agreementBonus.toFixed(1)}% bonus)`);

            let finalConfidence =
                (rfConfidence * 0.40) +
                (cnnConfidence * 0.25) +
                (svmConfidence * 0.15) +
                (gbConfidence * 0.10) +
                (validationConfidence * 0.05) +
                (caseSimilarity * 0.05) +
                agreementBonus;
            
            // Adjust confidence if some models failed
            const modelsAvailable = [
                rfResult.success !== false,
                svmResult.success !== false,
                gbResult.success !== false,
                cnnResult.success !== false
            ].filter(Boolean).length;
            
            if (modelsAvailable < 4) {
                console.log(` Only ${modelsAvailable}/4 models available, adjusting confidence`);
                finalConfidence *= (0.80 + (modelsAvailable * 0.05)); // Slight penalty for missing models
            }
            
            // Keep precision - don't round yet
            finalConfidence = Math.min(finalConfidence, 100);

            //-------------------------------------
            //  11. Display Confidence Adjustment
            //-------------------------------------
            let displayConfidence = finalConfidence;
            
            // If rule-based override was applied, adjust confidence based on override strength
            if (overrideApplied) {
                // Lab-based overrides: adjust based on how extreme the lab value is
                if (overrideReason.includes('TSH') || overrideReason.includes('T3') || overrideReason.includes('T4')) {
                    // Calculate boost based on lab value extremity
                    let labBoost = 0;
                    if (formData.tsh == 1 && (formData.tsh_value || formData.tshvalue)) {
                        const tshValue = parseFloat(formData.tsh_value || formData.tshvalue);
                        if (tshValue > 10) labBoost = 15; // Very high TSH
                        else if (tshValue > 7) labBoost = 12; // High TSH
                        else if (tshValue > 4) labBoost = 8; // Moderately high TSH
                        else if (tshValue < 0.1) labBoost = 15; // Very low TSH
                        else if (tshValue < 0.2) labBoost = 12; // Low TSH
                        else if (tshValue < 0.4) labBoost = 8; // Moderately low TSH
                    }
                    displayConfidence = Math.max(displayConfidence, 75 + labBoost);
                    console.log(` Confidence boosted due to lab results (+${labBoost}%): ${displayConfidence.toFixed(1)}%`);
                }
                // Clinical scoring overrides: adjust based on clinical score strength
                else if (overrideReason.includes('clinical evidence')) {
                    const clinicalBoost = Math.min(maxScore * 0.5, 15); // Up to 15% boost based on score
                    displayConfidence = Math.max(displayConfidence, 65 + clinicalBoost);
                    console.log(` Confidence adjusted based on clinical evidence (+${clinicalBoost.toFixed(1)}%): ${displayConfidence.toFixed(1)}%`);
                }
            }
            
            // Add variation based on data quality and completeness
            let dataQualityBonus = 0;
            
            // Bonus for having lab results
            if (formData.tsh == 1) dataQualityBonus += 2;
            if (formData.t3 == 1) dataQualityBonus += 1.5;
            if (formData.t4 == 1) dataQualityBonus += 1.5;
            
            // Bonus for complete symptom reporting
            const symptomFields = ['sym_fatigue', 'sym_weightchange', 'sym_dryskin', 'sym_hairloss', 
                                   'sym_heartrate', 'sym_digestion', 'sym_irregularperiods', 'sym_neckswelling'];
            const reportedSymptoms = symptomFields.filter(field => formData[field] !== undefined).length;
            dataQualityBonus += (reportedSymptoms / symptomFields.length) * 3;
            
            // Bonus for family history information
            const familyFields = ['fh_hypothyroidism', 'fh_hyperthyroidism', 'fh_goiter', 'fh_thyroidcancer'];
            const reportedFamily = familyFields.filter(field => formData[field] !== undefined).length;
            dataQualityBonus += (reportedFamily / familyFields.length) * 2;
            
            displayConfidence += dataQualityBonus;
            
            // Round to 1 decimal place and clamp to 0-100
            displayConfidence = Math.min(Math.max(Math.round(displayConfidence * 10) / 10, 0), 100);

            console.log(`\n`);
            console.log(` FINAL DIAGNOSIS SUMMARY`);
            console.log(``);
            console.log(` Final Prediction: ${finalPrediction.toUpperCase()}`);
            console.log(` Confidence: ${displayConfidence}%`);
            console.log(`\n ML Model Predictions:`);
            console.log(`   Random Forest: ${normalizedPredictions.rf} (${Math.round(rfConfidence)}%)`);
            console.log(`   SVM: ${normalizedPredictions.svm} (${Math.round(svmConfidence)}%)`);
            console.log(`   Gradient Boosting: ${normalizedPredictions.gb} (${Math.round(gbConfidence)}%)`);
            console.log(`   CNN Image: ${normalizedPredictions.cnn} (${Math.round(cnnConfidence)}%)`);
            console.log(`\n Clinical Scores:`);
            console.log(`   Hypothyroid: ${hypoScore} points`);
            console.log(`   Hyperthyroid: ${hyperScore} points`);
            console.log(`   Normal: ${normalScore} points`);
            if (overrideApplied) {
                console.log(`\n OVERRIDE APPLIED:`);
                console.log(`   ${overrideReason}`);
            }
            console.log(`\n`);

            //-------------------------------------
            // 12. Extract SHAP values from RF result OR generate from form data
            //-------------------------------------
            console.log(" Extracting SHAP values from RF result:", rfResult);
            
            let shapValues = [];
            
            // Try multiple possible locations for SHAP data
            if (rfResult.shap_values && Array.isArray(rfResult.shap_values)) {
                shapValues = rfResult.shap_values;
                console.log(" Found SHAP values in rfResult.shap_values");
            } else if (rfResult.shap_explanation) {
                shapValues = rfResult.shap_explanation;
                console.log(" Found SHAP values in rfResult.shap_explanation");
            } else if (rfResult.feature_importance) {
                shapValues = rfResult.feature_importance;
                console.log(" Found SHAP values in rfResult.feature_importance");
            } else if (rfResult.factors) {
                shapValues = rfResult.factors;
                console.log(" Found SHAP values in rfResult.factors");
            } else {
                console.log(" No SHAP values found in RF result, generating from form data...");
                
                // Map prediction to condition format expected by SHAP function
                // Backend returns: 'hypothyroid', 'hyperthyroid', 'normal'
                // SHAP function expects: 'hypo', 'hyper', 'normal'
                let conditionForSHAP = finalPrediction;
                if (finalPrediction === 'hypothyroid') conditionForSHAP = 'hypo';
                else if (finalPrediction === 'hyperthyroid') conditionForSHAP = 'hyper';
                
                console.log(` Mapping prediction '${finalPrediction}' to SHAP condition '${conditionForSHAP}'`);
                
                // Generate SHAP factors from form data
                const age = parseInt(formData.age) || 30;
                shapValues = generateEnhancedSHAPFactors(conditionForSHAP, age, []);
                
                console.log(" Generated SHAP factors from form data:", shapValues.length, "factors");
            }
            
            console.log(" Final SHAP values to display:", shapValues);

            //-------------------------------------
            // 13. Display All Model Results with status indicators and SHAP values
            //-------------------------------------
            console.log("\n");
            console.log(" SENDING TO DISPLAY:");
            console.log("   Prediction:", finalPrediction);
            console.log("   Confidence:", displayConfidence + "%");
            console.log("   SHAP Factors:", shapValues.length, "factors");
            if (shapValues.length > 0) {
                console.log("   Sample factors:");
                shapValues.slice(0, 3).forEach((f, i) => {
                    console.log(`      ${i+1}. ${f.name}: ${f.impact} (${f.type})`);
                });
            }
            console.log("\n");
            
            displayResults({
                prediction: finalPrediction,  // Use ensemble prediction instead of just RF
                confidence: displayConfidence,
                rf_prediction: rfResult.prediction,
                rf_confidence: Math.round(rfResult.confidence || 0),
                rf_status: rfResult.success !== false ? "" : "",
                svm_prediction: svmResult.prediction || "N/A",
                svm_confidence: Math.round(svmResult.confidence || 0),
                svm_status: svmResult.success !== false ? "" : "",
                gb_prediction: gbResult.prediction || "N/A",
                gb_confidence: Math.round(gbResult.confidence || 0),
                gb_status: gbResult.success !== false ? "" : "",
                case_similarity: Math.round(caseSimilarity),
                validation_confidence: Math.round(validationConfidence),
                mode: rfResult.mode || "Auto",
                cnn_prediction: cnnResult.prediction,
                cnn_confidence: Math.round(cnnConfidence || 0),
                cnn_status: "",
                shap_values: shapValues,
                shap_explanation: rfResult.shap_explanation || null,
                feature_importance: rfResult.feature_importance || null,
                message: rfResult.message || "Prediction complete",
                models_available: modelsAvailable,
                form_data: formData  // Pass form data for fallback generation
            });

        } catch (err) {
            console.error(" Prediction Error:", err);
            
            // Show detailed error message
            let errorMessage = " Prediction Error\n\n";
            errorMessage += err.message + "\n\n";
            errorMessage += "Possible causes:\n";
            errorMessage += " Backend server not running\n";
            errorMessage += " Network connection issue\n";
            errorMessage += " Invalid input data format\n\n";
            errorMessage += "Please check:\n";
            errorMessage += "1. Flask servers are running (ports 5000, 5001, 5002, 5003)\n";
            errorMessage += "2. All form fields are filled correctly\n";
            errorMessage += "3. Photo is uploaded\n";
            
            alert(errorMessage);
            
            // Show notification
            showNotification("Prediction failed: " + err.message, 'error');
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = "Submit Assessment";
        }
    });
});






















        function closeValidationStatus() {
            document.getElementById('validation-status').style.display = 'none';
        }
    </script>
    
    <!-- Enhanced SHAP Factors Script -->
    <script src="enhanced_shap_factors.js"></script>
</body>
</html>